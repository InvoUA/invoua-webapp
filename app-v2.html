<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) try { tg.expand(); } catch(e) {}

  const $ = s => document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const API = qs.get('api')?.replace(/\/$/,'') || '';

  const tbody = document.querySelector('#items tbody');
  function addRow(name='', qty='1', unit='se', price='0'){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name" placeholder="Послуга" value="${name}"></td>
      <td><input class="qty" type="number" step="0.01" value="${qty}"></td>
      <td><input class="unit" value="${unit}"></td>
      <td><input class="price" type="number" step="0.01" value="${price}"></td>
      <td><button class="secondary del">x</button></td>`;
    tr.querySelector('.del').onclick = () => tr.remove();
    tbody.appendChild(tr);
  }
  $('#add').onclick = () => addRow();
  if (!tbody.children.length) {
    addRow('Консультаційні послуги', '1', 'se', '1200');
    addRow('Реклама', '1', 'se', '500');
  }

  function collectItems(){
    return [...tbody.querySelectorAll('tr')].map(tr => ({
      name: tr.querySelector('.name').value.trim(),
      qty: tr.querySelector('.qty').value || '1',
      unit: tr.querySelector('.unit').value || 'se',
      price: tr.querySelector('.price').value || '0'
    })).filter(it => it.name);
  }

  async function saveInvoice(){
    if(!API){ alert('Не задано ?api= у URL'); throw new Error('API base is empty'); }
    const payload = {
      invoice: { currency: $('#currency').value },
      buyer:   { name: $('#buyer_name').value.trim() },
      items:   collectItems()
    };
    const r = await fetch(API + '/api/invoices', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'ngrok-skip-browser-warning': '1'
      },
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error('API error ' + r.status); }
    return await r.json();
  }

  async function getInvoiceJson(id){
    const r = await fetch(`${API}/api/invoices/${id}`, {
      headers: { 'ngrok-skip-browser-warning': '1' }
    });
    if(!r.ok) throw new Error('GET JSON ' + r.status);
    return await r.json();
  }

  function money(x){ return (Number(x)||0).toFixed(2); }

  // ---- jsPDF + шрифти (з фолбеком) ----
  function ab2b64(buf){
    let binary = ''; const bytes = new Uint8Array(buf);
    const chunk = 0x8000;
    for (let i=0; i<bytes.length; i+=chunk){
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
    }
    return btoa(binary);
  }
  async function loadFontsInto(pdf){
    const base = location.origin + location.pathname.replace(/\/[^\/]*$/, '') + '/fonts';
    const files = [
      {file:'DejaVuSans.ttf', name:'DejaVu', style:'normal'},
      {file:'DejaVuSans-Bold.ttf', name:'DejaVu', style:'bold'}
    ];
    for (const f of files){
      const res = await fetch(`${base}/${f.file}`, {cache:'reload'});
      if (!res.ok) throw new Error(`Font ${f.file} ${res.status}`);
      const buf = await res.arrayBuffer();
      pdf.addFileToVFS(f.file, ab2b64(buf));
      pdf.addFont(f.file, f.name, f.style);
    }
    pdf.setFont('DejaVu','normal');
  }

  function renderPdfFromJson(doc, pdf){
    const M = 12, W = pdf.internal.pageSize.getWidth() - M*2;
    const cur = doc.invoice.currency || 'UAH';
    const s = doc.seller || {}, b = doc.buyer || {};
    let y = 18;

    try { pdf.setFont('DejaVu','bold'); } catch(_) {}
    pdf.setFontSize(16);
    pdf.text(`Рахунок ${doc.invoice.number || ''}`, M, y); y += 6;

    try { pdf.setFont('DejaVu','normal'); } catch(_) {}
    pdf.setFontSize(10);
    pdf.text(`Дата: ${doc.invoice.issue_date || ''}`, M, y);
    if (doc.invoice.due_date) pdf.text(`Оплатити до: ${doc.invoice.due_date}`, M+60, y);
    y += 10;

    try { pdf.setFont('DejaVu','bold'); } catch(_) {}
    pdf.text('Продавець', M, y);
    try { pdf.setFont('DejaVu','normal'); } catch(_) {}
    const sellerLines = [s.name, s.tax_id && `ЄДРПОУ/ІПН: ${s.tax_id}`, s.iban && `IBAN: ${s.iban}`, s.address].filter(Boolean);
    sellerLines.forEach((t,i)=> pdf.text(String(t), M, y+6+i*5));

    try { pdf.setFont('DejaVu','bold'); } catch(_) {}
    pdf.text('Покупець', M+W/2, y);
    try { pdf.setFont('DejaVu','normal'); } catch(_) {}
    const buyerLines = [b.name, b.tax_id && `ЄДРПОУ/ІПН: ${b.tax_id}`, b.iban && `IBAN: ${b.iban}`, b.address].filter(Boolean);
    buyerLines.forEach((t,i)=> pdf.text(String(t), M+W/2, y+6+i*5));

    y += 6 + Math.max(sellerLines.length, buyerLines.length)*5 + 8;

    // Таблиця
    const cols = [
      { key:'name',  title:'Найменування', w:86 },
      { key:'qty',   title:'К-сть',         w:20 },
      { key:'unit',  title:'Од.',           w:20 },
      { key:'price', title:'Ціна',          w:30 },
      { key:'line_total', title:'Сума',     w:30 },
    ];
    try { pdf.setFont('DejaVu','bold'); } catch(_) {}
    let x = M; cols.forEach(c=>{ pdf.text(c.title, x+1, y); x += c.w; });
    y += 5; try { pdf.setFont('DejaVu','normal'); } catch(_) {}

    (doc.items||[]).forEach(it=>{
      x = M;
      const row = [
        String(it.name||''),
        String(it.qty||''),
        String(it.unit||''),
        money(it.price||'0'),
        money(it.line_total || (Number(it.qty||1)*Number(it.price||0)))
      ];
      row.forEach((v,i)=>{
        const cw = cols[i].w;
        const lines = pdf.splitTextToSize(v, cw-2);
        lines.forEach((ln,j)=> pdf.text(ln, x+1, y + j*5));
        y += (lines.length-1)*5;
        x += cw;
      });
      y += 6;
      if (y > 280){ pdf.addPage(); y = 20; }
    });

    y += 2;
    pdf.text(`Разом без ПДВ: ${money(doc.invoice.subtotal)} ${cur}`, M+W/2, y); y += 6;
    pdf.text(`ПДВ: ${money(doc.invoice.tax_total)} ${cur}`, M+W/2, y); y += 6;
    try { pdf.setFont('DejaVu','bold'); } catch(_) {}
    pdf.text(`До оплати: ${money(doc.invoice.total)} ${cur}`, M+W/2, y); y += 8;
    try { pdf.setFont('DejaVu','normal'); } catch(_) {}

    if (doc.invoice.notes){
      pdf.text('Примітки:', M, y); y += 5;
      pdf.text(pdf.splitTextToSize(String(doc.invoice.notes), W), M, y);
    }
  }

  // ---- UI ----
  $('#save').onclick = async () => {
    const toast = $('#toast');
    try{
      const res = await saveInvoice();
      $('#result').classList.remove('hidden');
      toast.classList.remove('err'); toast.classList.add('ok');
      toast.textContent = `Збережено. № ${res.number}. Сума: ${res.total}`;

      const id = res.id || res.invoice_id;
      const pdfUrl  = `${API}/api/invoices/${id}/pdf?ngrok-skip-browser-warning=1`;
      const htmlUrl = `${API}/api/invoices/${id}/html?ngrok-skip-browser-warning=1`;

      // Відкрити HTML у браузері/Telegram
      $('#btnHtml').onclick = () => {
        (window.Telegram?.WebApp?.openLink ? window.Telegram.WebApp.openLink(htmlUrl) : window.open(htmlUrl, '_blank'));
      };

      // Відкрити серверний PDF (через правильний ngrok-домен)
      const btnOpen = document.getElementById('btnPdf');
      btnOpen.textContent = 'Відкрити PDF (сервер)';
      btnOpen.onclick  = () => {
        (window.Telegram?.WebApp?.openLink ? window.Telegram.WebApp.openLink(pdfUrl) : window.open(pdfUrl, '_blank'));
      };

      // Додатково: Локальне завантаження (jsPDF), якщо хочеш — повісь на окрему кнопку
      // приклад: двоклік по тій же кнопці формує локально
      btnOpen.oncontextmenu = async (e) => {
        e.preventDefault();
        try {
          const doc = await getInvoiceJson(id);
          const { jsPDF } = window.jspdf || {};
          if(!jsPDF) throw new Error('jsPDF не завантажився');
          const pdf = new jsPDF('p','mm','a4');
          try { await loadFontsInto(pdf); } catch (fe) { console.warn('Font fallback:', fe); /* залишиться вбудований */ }
          renderPdfFromJson(doc, pdf);
          pdf.save('invoice.pdf'); // миттєве завантаження
        } catch (e2) {
          toast.classList.remove('ok'); toast.classList.add('err');
          toast.textContent = 'Помилка PDF (локально): ' + e2.message;
        }
      };

      document.getElementById('btnNew').onclick  = () => location.reload();
    }catch(e){
      $('#result').classList.remove('hidden');
      toast.classList.remove('ok'); toast.classList.add('err');
      toast.textContent = 'Помилка збереження: ' + e.message;
    }
  };
})();
</script>
