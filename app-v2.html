<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Створення рахунку</title>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --muted:#666; --border:#eee; --accent:#0a7cff; --black:#111; }
    html,body { margin:0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; background:var(--bg); padding:16px; }
    .card { background:var(--card); border-radius:14px; padding:16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); max-width:980px; margin:0 auto; }
    h1 { margin:0 0 12px 0; font-size:22px; }
    fieldset { border:1px solid var(--border); border-radius:10px; margin:12px 0; padding:12px; }
    legend { padding:0 6px; color:#555; }
    .row { display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
    label { display:block; font-size:12px; color:#555; margin-bottom:4px; }
    input, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid var(--border); padding:8px; vertical-align:top; }
    tfoot td { border:none; }
    .btn { background:var(--black); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:var(--accent); }
    .btn.link { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .muted { color:var(--muted); font-size:12px; }
    .links a { display:inline-block; margin-right:10px; text-decoration:none; }
    .diag { background:#fafafa; border:1px dashed var(--border); border-radius:10px; padding:10px; margin:10px 0; }
    code { background:#f0f3f6; padding:2px 6px; border-radius:6px; }
    .right { text-align:right; }
  </style>

  <!-- 1) базові адреси -->
  <script src="./webapp_env.js"></script>
  <!-- 2) міст до Telegram WebApp (опційно: працює, коли сторінка відкрито в Telegram) -->
  <script src="./webapp_tg_bridge.js"></script>
</head>
<body>
  <div class="card">
    <h1>Новий рахунок</h1>

    <div class="diag">
      <div class="muted">Діагностика підключення:</div>
      <div>API_BASE: <code id="apiBase">(визначаю...)</code></div>
      <div>APP_BASE: <code id="appBase">(визначаю...)</code></div>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
        <button class="btn link" onclick="openHealth()">Відкрити health</button>
        <button class="btn link" onclick="pingApi()">Ping API</button>
        <button class="btn link" onclick="copyApi()">Копіювати API_BASE</button>
      </div>
      <div id="diagMsg" class="muted" style="margin-top:6px"></div>
    </div>

    <fieldset>
      <legend>Продавець</legend>
      <div class="row">
        <div><label>Назва</label><input id="seller_name" placeholder="ФОП Іваненко Іван"></div>
        <div><label>Місто/адреса</label><input id="seller_addr" placeholder="Київ"></div>
        <div><label>IBAN</label><input id="seller_iban" placeholder="UA..."></div>
        <div><label>ЄДРПОУ/ІПН</label><input id="seller_tax" placeholder="1234567890"></div>
        <div><label>Email</label><input id="seller_email" placeholder="name@example.com"></div>
        <div><label>Телефон</label><input id="seller_phone" placeholder="+380..."></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Покупець</legend>
      <div class="row">
        <div><label>Назва</label><input id="buyer_name" placeholder="ТОВ Ромашка"></div>
        <div><label>Адреса</label><input id="buyer_addr" placeholder="Львів"></div>
        <div><label>ЄДРПОУ/ІПН</label><input id="buyer_tax" placeholder="12345678"></div>
        <div><label>Email</label><input id="buyer_email" placeholder="client@example.com"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Позиції</legend>
      <table id="items">
        <thead><tr><th>Найменування</th><th style="width:100px">К-сть</th><th style="width:100px">Од.</th><th style="width:140px">Ціна</th><th style="width:60px"></th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="muted">Формат ціни та сум: <code>1234,56</code> (кома як роздільник копійок)</td>
          </tr>
        </tfoot>
      </table>
      <div style="margin-top:8px">
        <button class="btn secondary" onclick="addRow()">+ Додати позицію</button>
        <button class="btn link" onclick="addRow('Послуги', '1', 'шт', '1000,00')">+ Шаблон</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Налаштування</legend>
      <div class="row">
        <div>
          <label>Валюта</label>
          <select id="currency">
            <option value="UAH" selected>UAH</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div><label>Примітки</label><input id="notes" placeholder="Без ПДВ"></div>
        <div><label>Місто виписки</label><input id="place_city" placeholder="Київ"></div>
      </div>
    </fieldset>

    <div style="display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap">
      <button class="btn" onclick="createInvoice()">Створити рахунок</button>
      <span id="status" class="muted"></span>
    </div>

    <div id="links" class="links" style="margin-top:10px"></div>
  </div>

<script>
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return [...document.querySelectorAll(sel)]; }
function trimSlash(s){ return (s||"").replace(/\/+$/,''); }

function resolveApiBase() {
  let api = (window.API_BASE || "").trim();
  if (!api && (location.hostname === "127.0.0.1" || location.hostname === "localhost")) {
    api = "http://127.0.0.1:8081";
  }
  return trimSlash(api);
}

function showEnv() {
  const api = resolveApiBase();
  const app = trimSlash(window.APP_BASE || location.origin);
  $("#apiBase").textContent = api || "(не задано)";
  $("#appBase").textContent = app || "(невідомо)";
  $("#diagMsg").textContent = api ? "" : "API_BASE не знайдено. Переконайтесь, що webapp_env.js заповнений або запустіть локально API на 8081.";
}

function addRow(name="", qty="1", unit="шт", price="0,00") {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${name}"></td>
    <td><input value="${qty}" style="width:90px"></td>
    <td><input value="${unit}" style="width:90px"></td>
    <td><input value="${price}" style="width:130px"></td>
    <td class="right"><button class="btn" title="Видалити" onclick="this.closest('tr').remove()">×</button></td>`;
  $('#items tbody').appendChild(tr);
}
addRow();

function openHealth(){
  const api = resolveApiBase();
  if (!api) { alert("API_BASE не заданий"); return; }
  window.open(api + "/health", "_blank");
}

async function pingApi(){
  const api = resolveApiBase();
  if (!api) { $("#diagMsg").textContent = "API_BASE не заданий"; return; }
  $("#diagMsg").textContent = "Ping...";
  try {
    const r = await fetch(api + "/health", {cache:"no-store"});
    const ctype = (r.headers.get("content-type")||"").toLowerCase();
    if (!ctype.includes("application/json")) {
      $("#diagMsg").textContent = "API повернув не JSON (ймовірно, «welcome/consent» сторінка ngrok). Натисніть «Відкрити health», погодьтеся, потім «Ping API».";
      return;
    }
    const j = await r.json();
    $("#diagMsg").textContent = "OK: " + JSON.stringify(j);
  } catch (e) {
    $("#diagMsg").textContent = "Помилка під час ping: " + (e.message || e);
  }
}

async function createInvoice(){
  const status = $("#status");
  const api = resolveApiBase();
  if (!api) { status.textContent = "API_BASE не заданий (перевір webapp_env.js)."; return; }

  status.textContent = "Надсилаю дані…";

  const items = $all('#items tbody tr').map(tr => {
    const [nameEl, qtyEl, unitEl, priceEl] = tr.querySelectorAll('input');
    return { name: nameEl.value, qty: qtyEl.value, unit: unitEl.value, price: priceEl.value };
  });

  const payload = {
    seller: {
      name: $("#seller_name").value, address: $("#seller_addr").value,
      iban: $("#seller_iban").value, tax_id: $("#seller_tax").value,
      email: $("#seller_email").value, phone: $("#seller_phone").value
    },
    buyer: {
      name: $("#buyer_name").value, address: $("#buyer_addr").value,
      tax_id: $("#buyer_tax").value, email: $("#buyer_email").value
    },
    items,
    invoice: { currency: $("#currency").value, notes: $("#notes").value, place_city: $("#place_city").value }
  };

  try {
    const r = await fetch(api + "/api/invoices", {
      method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(payload)
    });

    const ctype = (r.headers.get("content-type")||"").toLowerCase();
    if (!ctype.includes("application/json")) {
      status.textContent = "API повернув не JSON (можливо, welcome/consent від ngrok). Натисніть «Відкрити health», погодьтеся та повторіть.";
      return;
    }

    if (!r.ok) throw new Error("HTTP " + r.status);
    const data = await r.json();

    const links = data.links || {};
    const id = data.id;
    const pdf = links.pdf ? (api + links.pdf) : (api + `/api/invoices/${id}/pdf?dl=1`);
    const html = links.html ? (api + links.html) : (api + `/api/invoices/${id}/html`);

    $("#links").innerHTML = `
      <a class="btn" href="${pdf}" target="_blank" download>⬇️ PDF</a>
      <a class="btn secondary" href="${html}" target="_blank">🔎 HTML</a>
    `;
    status.textContent = "Готово!";
  } catch (e) {
    status.textContent = "Помилка: " + (e.message || e);
  }
}

async function copyApi(){
  const api = resolveApiBase();
  if (!api) { alert("API_BASE не заданий"); return; }
  try {
    await navigator.clipboard.writeText(api);
    $("#diagMsg").textContent = "API_BASE скопійовано в буфер обміну.";
  } catch {
    $("#diagMsg").textContent = "Не вдалося скопіювати API_BASE.";
  }
}

showEnv();
</script>
</body>
</html>
