<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>InvoUA – створити рахунок</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="./webapp_env.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .card { max-width: 760px; margin: 0 auto; padding: 16px; border: 1px solid #ddd; border-radius: 12px; }
    h1 { font-size: 20px; margin-top: 0; }
    fieldset { border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px; }
    legend { font-weight: 600; padding: 0 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 13px; color: #444; display: block; margin-bottom: 4px; }
    input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    .primary { background: #0d6efd; color: white; }
    .muted { color: #666; font-size: 13px; }
    .actions { display:flex; gap: 8px; justify-content: flex-end; }
    .ok { color: #0a8a0a; }
    .err{ color: #c00; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Створення рахунку (PDF)</h1>
    <div id="status" class="muted"></div>

    <form id="f">
      <fieldset>
        <legend>Платник (Buyer)</legend>
        <div class="row">
          <div><label>Назва/ПІБ</label><input name="buyer.name" placeholder="ТОВ Ромашка" required /></div>
          <div><label>ЄДРПОУ/ІПН</label><input name="buyer.tax_id" placeholder="12345678" /></div>
          <div><label>Адреса</label><input name="buyer.address" placeholder="м. Львів, вул. ..." /></div>
          <div><label>Email</label><input name="buyer.email" type="email" placeholder="client@example.com" /></div>
          <div><label>Телефон</label><input name="buyer.phone" placeholder="+380..." /></div>
          <div><label>IBAN</label><input name="buyer.iban" placeholder="UA..." /></div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Отримувач (Seller)</legend>
        <div class="row">
          <div><label>Назва/ПІБ</label><input name="seller.name" placeholder="ФОП Іваненко Іван" /></div>
          <div><label>ІПН</label><input name="seller.tax_id" placeholder="1234567890" /></div>
          <div><label>Адреса</label><input name="seller.address" placeholder="м. Київ, ..." /></div>
          <div><label>Email</label><input name="seller.email" type="email" placeholder="me@example.com" /></div>
          <div><label>Телефон</label><input name="seller.phone" placeholder="+380..." /></div>
          <div><label>IBAN</label><input name="seller.iban" placeholder="UA..." /></div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Позиція</legend>
        <div class="row">
          <div><label>Назва</label><input name="items.0.name" placeholder="Послуги обліку" required /></div>
          <div><label>Одиниця</label><input name="items.0.unit" placeholder="шт" value="шт" /></div>
          <div><label>Кількість</label><input name="items.0.qty" type="number" step="0.01" value="1" /></div>
          <div><label>Ціна (кома)</label><input name="items.0.price" placeholder="1000,00" required /></div>
        </div>
        <div><label>Опис</label><input name="description" placeholder="Додатковий опис (необов’язково)" /></div>
      </fieldset>

      <fieldset>
        <legend>Інше</legend>
        <div class="row">
          <div><label>Валюта</label>
            <select name="invoice.currency">
              <option>UAH</option><option>USD</option><option>EUR</option>
            </select>
          </div>
          <div><label>Нотатки</label><input name="invoice.notes" placeholder="Без ПДВ / Договір №..." /></div>
        </div>
      </fieldset>

      <div class="actions">
        <button type="submit" class="primary">Створити PDF</button>
      </div>
    </form>

    <div id="msg"></div>
  </div>

<script>
(function(){
  // 1) середовище (API/APP)
  const qs = new URLSearchParams(location.search);
  let API_BASE = (qs.get('api') || (window.API_BASE||'')).replace(/\/+$/,'');
  let APP_BASE = (qs.get('app') || (window.APP_BASE||location.origin)).replace(/\/+$/,'');

  const statusEl = document.getElementById('status');
  statusEl.textContent = `API: ${API_BASE || '—'} • APP: ${APP_BASE || '—'}`;

  // Telegram WebApp bridge (опційно)
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg && tg.ready) tg.ready();

  function flatToNested(formData) {
    const root = {};
    for (const [k,v] of formData.entries()) {
      const path = k.split('.'); let obj = root;
      while (path.length > 1) {
        const key = path.shift();
        if (!obj[key]) obj[key] = ( /^\d+$/.test(path[0]) ? [] : {} );
        obj = obj[key];
      }
      obj[path[0]] = v;
    }
    // Перетворимо items.{index}.field у масив
    if (root.items) {
      const arr = [];
      Object.keys(root.items).forEach(idx => { arr[idx|0] = root.items[idx]; });
      root.items = arr.filter(Boolean);
    }
    return root;
  }

  async function postJson(url, data) {
    // ключовий заголовок, щоб оминути "welcome" екран ngrok
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'ngrok-skip-browser-warning': '1',
        'User-Agent':'invoua-webapp'
      },
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=>`${res.status}`);
      throw new Error(`HTTP ${res.status}: ${txt}`);
    }
    return await res.json();
  }

  async function downloadPdf(invId, filenameHint='invoice.pdf') {
    const url = `${API_BASE}/api/invoices/${encodeURIComponent(invId)}/pdf?dl=1`;
    const r = await fetch(url, { headers: {'ngrok-skip-browser-warning':'1','User-Agent':'invoua-webapp'} });
    if (!r.ok) { throw new Error(`PDF HTTP ${r.status}`); }
    const blob = await r.blob();
    const a = document.createElement('a');
    const urlObj = URL.createObjectURL(blob);
    a.href = urlObj;
    a.download = filenameHint;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(urlObj); a.remove(); }, 1000);
  }

  document.getElementById('f').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const msg = document.getElementById('msg'); msg.textContent = ""; msg.className="";
    try {
      if (!API_BASE) throw new Error("API_BASE не задано");
      const data = flatToNested(new FormData(e.target));

      // якщо не вказали seller/buyer — хай буде порожньо, API сам підставить що може
      data.invoice = Object.assign({ currency:"UAH" }, data.invoice||{});

      const resp = await postJson(`${API_BASE}/api/invoices`, data);
      const invId = resp.id;
      const number = (resp.invoice && resp.invoice.number) || invId;

      msg.textContent = `✅ Рахунок створено: ${number}. Завантажую PDF...`;
      msg.className = "ok";

      // Скачування PDF як файлу (обхід екрана ngrok + працює в Telegram WebApp)
      await downloadPdf(invId, `${number}.pdf`);

      // Якщо це Telegram — повідомимо бота
      try {
        if (tg && tg.sendData) {
          tg.sendData(JSON.stringify({
            type:'invoice_created',
            id: invId,
            number,
            public_url: `${API_BASE}/api/invoices/${invId}/html`,
            pdf_url: `${API_BASE}/api/invoices/${invId}/pdf?dl=1`
          }));
        }
      } catch(_) {}
    } catch (err) {
      msg.textContent = "❌ Помилка: " + (err && err.message || err);
      msg.className = "err";
    }
  });
})();
</script>
</body>
</html>
