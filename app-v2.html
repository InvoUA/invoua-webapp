<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>InvoUA — створити рахунок</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 1) Підтягуємо пари базових URL (оновлювані start_all.ps1) -->
  <script src="webapp_env.js"></script>
  <!-- 2) TG WebApp SDK (у WebView Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    .card { max-width: 720px; margin: 0 auto; padding: 16px; border: 1px solid #e6e6e6; border-radius: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 14px; color: #333; display: block; margin-bottom: 6px; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .actions { display: flex; gap: 12px; margin-top: 16px; }
    button { padding: 12px 16px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
    .primary { background: #0a84ff; color: #fff; }
    .muted { background: #eee; }
    .hint { font-size: 13px; color: #666; margin-top: 8px; }
    .ok { color: #0a8; }
    .err { color: #b00; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Створити рахунок</h1>

    <form id="invForm">
      <div class="row">
        <div>
          <label>Сума (кома)</label>
          <input id="amount" placeholder="1234,56" required />
        </div>
        <div>
          <label>Валюта</label>
          <select id="currency">
            <option value="UAH" selected>UAH</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Опис</label>
          <input id="description" placeholder="Послуги ..." required />
        </div>
        <div>
          <label>Місто (місце складання)</label>
          <input id="place_city" placeholder="Київ" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Примітки</label>
        <textarea id="notes" rows="2" placeholder="Без ПДВ"></textarea>
      </div>

      <div class="actions">
        <button type="submit" class="primary">Створити PDF</button>
        <button type="button" id="openPdf" class="muted">Відкрити PDF</button>
      </div>
      <div id="msg" class="hint"></div>
    </form>
  </div>

<script>
(function () {
  // 0) Пара з URL: беремо з webapp_env.js, але дозволяємо query-перевизначення
  const url = new URL(window.location.href);
  const API_BASE = (url.searchParams.get('api') || window.API_BASE || '').replace(/\/+$/,'');
  const APP_BASE = (url.searchParams.get('app') || window.APP_BASE || location.origin).replace(/\/+$/,'');

  // 1) Універсальний fetch з хедером, який прибирає splash-сторінку ngrok
  async function apiFetch(path, opts = {}) {
    const init = Object.assign({ headers: {} }, opts);
    init.headers['ngrok-skip-browser-warning'] = '1';
    return fetch(API_BASE + path, init);
  }

  // 2) Надсилання в бот (коли форма в TG WebView)
  const tg = window.Telegram && window.Telegram.WebApp;
  function sendToBot(payload) {
    try { tg && tg.sendData && tg.sendData(JSON.stringify(payload)); } catch (e) {}
  }

  // 3) Стан сторінки
  let lastInvoice = null; // {id, number, pdf_url, public_url}

  // 4) Submit форми -> створюємо інвойс через API (POST /api/invoices), скачати PDF як blob (без splash)
  document.getElementById('invForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('msg');
    msg.textContent = "Створюю рахунок…";

    const payload = {
      amount: document.getElementById('amount').value.trim(),
      description: document.getElementById('description').value.trim(),
      invoice: {
        currency: document.getElementById('currency').value,
        notes: document.getElementById('notes').value.trim(),
        place_city: document.getElementById('place_city').value.trim()
      }
    };

    try {
      const res = await apiFetch('/api/invoices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': '1' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`Помилка API (${res.status}): ${t}`);
      }
      const data = await res.json();
      const invId = data.id;
      const number = (data.invoice && data.invoice.number) || invId;

      // Скачати PDF як blob (з хедером — без splash), показати save/open
      const pdfRes = await apiFetch(`/api/invoices/${invId}/pdf?dl=1`);
      if (!pdfRes.ok) {
        const t = await pdfRes.text();
        throw new Error(`PDF помилка (${pdfRes.status}): ${t}`);
      }
      const blob = await pdfRes.blob();
      const a = document.createElement('a');
      const urlObj = URL.createObjectURL(blob);
      a.href = urlObj;
      a.download = (data.invoice && data.invoice.number ? data.invoice.number : `invoice-${invId}`) + ".pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(urlObj), 10000);

      // збережемо для кнопки “Відкрити PDF”
      lastInvoice = {
        id: invId,
        number,
        pdf_url: `${API_BASE}/api/invoices/${invId}/pdf?dl=1`,
        public_url: `${API_BASE}/api/invoices/${invId}/html`
      };

      msg.innerHTML = `<span class="ok">✅ Рахунок ${number} створено і PDF завантажено.</span>`;

      // якщо це Telegram WebApp — повідомляємо боту ID
      sendToBot({ type: 'invoice_created', id: invId, number, pdf_url: lastInvoice.pdf_url, html_url: lastInvoice.public_url });
    } catch (err) {
      console.error(err);
      msg.innerHTML = `<span class="err">❌ ${err.message || err}</span>`;
    }
  });

  // 5) Кнопка “Відкрити PDF” — безпосередньо завантажує blob з хедером, відкриває в новій вкладці
  document.getElementById('openPdf').addEventListener('click', async () => {
    const msg = document.getElementById('msg');
    if (!lastInvoice) {
      msg.textContent = "Спочатку створіть рахунок.";
      return;
    }
    try {
      const pdfRes = await apiFetch(`/api/invoices/${lastInvoice.id}/pdf?dl=1`);
      if (!pdfRes.ok) throw new Error(`PDF помилка (${pdfRes.status})`);
      const blob = await pdfRes.blob();
      const urlObj = URL.createObjectURL(blob);
      window.open(urlObj, '_blank');
      setTimeout(() => URL.revokeObjectURL(urlObj), 15000);
    } catch (e) {
      msg.innerHTML = `<span class="err">❌ ${e.message || e}</span>`;
    }
  });
})();
</script>
</body>
</html>
