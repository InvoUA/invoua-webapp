<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>InvOUA WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 18px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input, textarea { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .btn { display:inline-block; padding:8px 12px; margin-top:12px; border:1px solid #ccc; border-radius:6px; cursor:pointer; background:#f6f6f6; }
    .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .muted { color:#666; font-size:13px; }
    pre { background:#111; color:#9ef; padding:10px; border-radius:6px; max-height:220px; overflow:auto;}
  </style>
</head>
<script>
// ---------- API base from ?api= ----------
const QS = new URLSearchParams(location.search);
const API_BASE = QS.get('api') || '';
if (!API_BASE) console.warn('⚠️ Не задано ?api= у URL');

// ---------- Bypass ngrok landing ----------
function ngrokize(url) {
  try {
    const u = new URL(url, location.href);
    if (u.host.includes('ngrok-free.app') && !u.searchParams.has('ngrok-skip-browser-warning')) {
      u.searchParams.set('ngrok-skip-browser-warning', '1');
    }
    return u.toString();
  } catch { return url; }
}

// ---------- Fetch wrapper з header для ngrok ----------
async function apiFetch(path, opts = {}) {
  const url = API_BASE.replace(/\/+$/,'') + '/' + path.replace(/^\/+/, '');
  const headers = {
    'ngrok-skip-browser-warning': '1',
    ...(opts.headers || {})
  };
  const init = { ...opts, headers };
  return fetch(url, init);
}

// ---------- Відкрити PDF (inline або завантаження) ----------
function openInvoicePdf(invoiceId, download = false) {
  const base = API_BASE.replace(/\/+$/,'') + `/api/invoices/${encodeURIComponent(invoiceId)}/pdf`;
  const url = new URL(base);
  url.searchParams.set('download', download ? '1' : '0');
  // головне — додати skip:
  const finalUrl = ngrokize(url.toString());
  window.open(finalUrl, '_blank', 'noopener');
}

// Зробимо доступним з будь-якого місця
window.INVOUA = { apiFetch, openInvoicePdf };

// ---------- Wipe mode (кеш браузера) ----------
(async function wipeIfAsked(){
  if (!QS.has('wipe') && !QS.has('wipe_fonts')) return;
  try {
    if (window.caches?.keys) {
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n).catch(()=>{})));
    }
    if (indexedDB?.databases) {
      const dbs = await indexedDB.databases();
      await Promise.all((dbs || []).map(d => new Promise(res => {
        const req = indexedDB.deleteDatabase(d.name);
        req.onsuccess = req.onerror = req.onblocked = () => res();
      })));
    }
    try { localStorage.clear(); } catch(_){}
    try { sessionStorage.clear(); } catch(_){}
  } catch(e) {
    console.warn('Wipe error:', e);
  }
  // перезавантажимо з версією, щоб пробити кеш
  QS.delete('wipe'); QS.delete('wipe_fonts');
  if (!QS.has('v')) QS.set('v', Date.now());
  location.replace(location.pathname + '?' + QS.toString());
})();
</script>
<body>
  <h2>InvOUA – демо</h2>
  <div id="status" class="muted"></div>

  <div class="row">
    <div>
      <h3>Продавець</h3>
      <label>Назва <input id="s_name" placeholder="ТОВ Приклад"></label>
      <label>Адреса <input id="s_addr" placeholder="м. Київ, вул…"></label>
      <label>Email <input id="s_email" placeholder="seller@example.com"></label>
      <label>Телефон <input id="s_phone" placeholder="+380…"></label>
      <label>IBAN <input id="s_iban" placeholder="UA…"></label>
      <label>ЄДРПОУ/ІПН <input id="s_tax" placeholder="12345678"></label>
      <label>Лого URL <input id="s_logo" placeholder="https://...png"></label>
      <label>Печатка URL <input id="s_stamp" placeholder="https://...png"></label>
      <label>Підпис URL <input id="s_sign" placeholder="https://...png"></label>
      <button class="btn" id="saveSeller">Зберегти продавця</button>
      <div class="muted">Використовуватиметься в рахунку</div>
    </div>
    <div>
      <h3>Покупець</h3>
      <label>Назва <input id="b_name" placeholder="ФОП Іванов"></label>
      <label>Адреса <input id="b_addr" placeholder="м. Львів, вул…"></label>
      <label>Email <input id="b_email" placeholder="buyer@example.com"></label>
      <label>Телефон <input id="b_phone" placeholder="+380…"></label>

      <h3 style="margin-top:20px">Позиції</h3>
      <label>Найменування <input id="it_name" value="Послуги"></label>
      <label>К-сть <input id="it_qty" type="number" step="1" value="1"></label>
      <label>Од. <input id="it_unit" value="шт"></label>
      <label>Ціна <input id="it_price" type="number" step="0.01" value="1700"></label>

      <h3 style="margin-top:20px">Рахунок</h3>
      <label>Номер <input id="inv_no" placeholder="(auto)"></label>
      <label>Валюта <input id="inv_cur" value="UAH"></label>
      <label>Нотатка <textarea id="inv_notes" rows="2"></textarea></label>

      <button class="btn primary" id="makeInvoice">Створити рахунок</button>
      <div id="afterCreate" style="display:none; margin-top:10px">
        <button class="btn" id="openPdf">Відкрити PDF</button>
        <button class="btn" id="downloadPdf">Завантажити PDF</button>
        <button class="btn" id="openHtml">Переглянути HTML</button>
      </div>
    </div>
  </div>

  <h3 style="margin-top:24px">Журнал</h3>
  <pre id="log"></pre>

<script>
// ---- Wipe mode ----
(async function wipeIfAsked(){
  const qs = new URLSearchParams(location.search);
  if (!qs.has('wipe') && !qs.has('wipe_fonts')) return;

  try {
    // Cache Storage
    if (window.caches && caches.keys) {
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n).catch(()=>{})));
    }
    // IndexedDB
    if (indexedDB && indexedDB.databases) {
      const dbs = await indexedDB.databases();
      await Promise.all((dbs||[]).map(d => new Promise(res=>{
        const req = indexedDB.deleteDatabase(d.name); req.onsuccess = req.onerror = req.onblocked = ()=>res();
      })));
    }
    // Web Storage
    try { localStorage.clear(); } catch(_){}
    try { sessionStorage.clear(); } catch(_){}
  } catch(e) {
    console.warn('Wipe error:', e);
  }

  // Reopen without wipe flag and with version bump
  qs.delete('wipe'); qs.delete('wipe_fonts');
  if (!qs.has('v')) qs.set('v', Date.now().toString());
  location.replace(location.pathname + '?' + qs.toString());
})();

const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
function log(...args){ const s=args.map(x=>typeof x=='string'?x:JSON.stringify(x,null,2)).join(' '); logEl.textContent += s + '\n'; }

const params = new URLSearchParams(location.search);
const API = params.get('api');
if(!API){
  statusEl.textContent = 'Помилка: у URL має бути ?api=... (адреса вашого API/ngrok).';
} else {
  statusEl.textContent = 'API = ' + API;
}

// helper: attach ngrok bypass header always; also append ?ngrok-skip-browser-warning=1 to GETs
function urlWithBypass(u){
  try{
    const url = new URL(u, API);
    if(!url.searchParams.has('ngrok-skip-browser-warning')){
      url.searchParams.set('ngrok-skip-browser-warning','1');
    }
    return url.toString();
  }catch(e){
    return u;
  }
}
async function apiFetch(path, options={}){
  const headers = Object.assign({
    'Content-Type':'application/json',
    'ngrok-skip-browser-warning':'1'
  }, options.headers||{});
  const url = urlWithBypass(API.replace(/\/+$/,'') + path);
  const res = await fetch(url, {...options, headers});
  if(!res.ok){
    const text = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}: ${text}`);
  }
  const ct = res.headers.get('content-type') || '';
  if(ct.includes('application/json')) return res.json();
  return res.text();
}

// save seller
document.getElementById('saveSeller').onclick = async () => {
  try{
    const seller = {
      name: s_name.value, address: s_addr.value, email: s_email.value, phone: s_phone.value,
      iban: s_iban.value, tax_id: s_tax.value, logo_url: s_logo.value, stamp_url: s_stamp.value, sign_url: s_sign.value
    };
    const r = await apiFetch('/api/seller', { method:'PUT', body: JSON.stringify(seller) });
    log('seller saved:', r);
    alert('Збережено продавця');
  }catch(e){
    log('seller save error:', e.message);
    alert('Помилка збереження продавця: ' + e.message);
  }
};

// create invoice
let lastInvoiceId = null;
document.getElementById('makeInvoice').onclick = async () => {
  try{
    const payload = {
      seller: {
        name: s_name.value, address: s_addr.value, email: s_email.value, phone: s_phone.value,
        iban: s_iban.value, tax_id: s_tax.value, logo_url: s_logo.value, stamp_url: s_stamp.value, sign_url: s_sign.value
      },
      buyer: { name: b_name.value, address: b_addr.value, email: b_email.value, phone: b_phone.value },
      items: [{ name: it_name.value, qty: Number(it_qty.value||1), unit: it_unit.value||'шт', price: Number(it_price.value||0) }],
      invoice: { number: inv_no.value || '', currency: inv_cur.value||'UAH', notes: inv_notes.value||'' }
    };
    const r = await apiFetch('/api/invoices', { method:'POST', body: JSON.stringify(payload) });
    log('invoice created:', r);
    lastInvoiceId = r.id;
    document.getElementById('afterCreate').style.display = 'block';
  }catch(e){
    log('invoice create error:', e.message);
    alert('Помилка створення рахунку: ' + e.message);
  }
};

// open PDF WITHOUT ngrok landing: fetch -> blob -> open blob:
async function openPdfBlob(invId, download=false){
  const pdfUrl = urlWithBypass(API.replace(/\/+$/,'') + `/api/invoices/${invId}/pdf`);
  try{
    const res = await fetch(pdfUrl, { headers: { 'ngrok-skip-browser-warning':'1' }});
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const blob = await res.blob();
    const blobUrl = URL.createObjectURL(blob);
    if(download){
      const a = document.createElement('a'); a.href = blobUrl; a.download = `${invId}.pdf`;
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(blobUrl), 2000);
    }else{
      window.open(blobUrl, '_blank'); // opens viewer without touching ngrok host directly
      setTimeout(()=>URL.revokeObjectURL(blobUrl), 60000);
    }
  }catch(e){
    log('pdf open error:', e.message);
    // fallback: navigate to direct URL (still with bypass param)
    window.open(pdfUrl, '_blank');
  }
}
document.getElementById('openPdf').onclick = async () => {
  if(!lastInvoiceId){ return alert('Спершу створіть рахунок.'); }
  openPdfBlob(lastInvoiceId,false);
};
document.getElementById('downloadPdf').onclick = async () => {
  if(!lastInvoiceId){ return alert('Спершу створіть рахунок.'); }
  openPdfBlob(lastInvoiceId,true);
};
document.getElementById('openHtml').onclick = async () => {
  if(!lastInvoiceId){ return alert('Спершу створіть рахунок.'); }
  const u = urlWithBypass(API.replace(/\/+$/,'') + `/api/invoices/${lastInvoiceId}/html`);
  window.open(u, '_blank');
};
</script>
</body>
</html>
