<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>InvoUA — рахунок за 60 секунд / v2.3</title>
<style>
:root{--gap:10px} body{font-family:system-ui,-apple-system,Arial,sans-serif;margin:0;padding:14px}
h1{font-size:20px;margin:0 0 12px 0}.grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
label{font-size:12px;color:#444} input,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid #ddd;padding:8px;font-size:14px}
th{background:#f8f8f8;text-align:left}.btns{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
button{padding:10px 14px;border:0;border-radius:999px;background:#0a84ff;color:#fff;font-weight:600}
button.secondary{background:#eee;color:#222}.muted{color:#666;font-size:12px}
.toast{margin-top:10px;font-size:13px}.ok{color:#0a7d2f}.err{color:#b00020}.hidden{display:none}
.card{border:1px solid #eee;border-radius:12px;padding:12px;margin-bottom:12px}
.card h2{font-size:14px;margin:0 0 8px 0;color:#333}.row{display:flex;gap:10px;flex-wrap:wrap}.row>div{flex:1 1 240px}
.small{font-size:12px;color:#666}
</style>
<script src="./webapp_bridge.js"></script>
</head>
<body>
<h1>InvoUA — рахунок за 60 секунд <span class="small">/ v2.3</span></h1>

<!-- (профіль продавця опущено для стислості — лиши як у твоїй актуальній v2.2, він сумісний) -->

<div class="grid">
  <div><label>Покупець (назва/ПІБ)</label><input id="buyer_name" placeholder="ТОВ Приклад"></div>
  <div><label>Валюта</label><select id="currency"><option>UAH</option><option>USD</option><option>EUR</option></select></div>
</div>

<table id="items"><thead><tr>
  <th>Найменування</th><th style="width:80px">К-сть</th><th style="width:80px">Од.</th><th style="width:120px">Ціна</th><th style="width:40px"></th>
</tr></thead><tbody></tbody></table>

<div class="btns">
  <button id="add">+ Додати позицію</button>
  <button id="save">Зберегти рахунок</button>
</div>

<div id="result" class="hidden">
  <div class="btns">
    <button id="btnPdf">Завантажити PDF</button>
    <button id="btnHtml" class="secondary">Поділитися (HTML)</button>
    <button id="btnNew" class="secondary">Новий</button>
  </div>
  <div id="toast" class="toast ok"></div>
</div>

<p class="muted">API береться з параметра <code>?api=</code>.</p>

<script>
(function(){
  const tg = window.Telegram?.WebApp; if(tg){ try{ tg.expand() }catch(e){} }
  const $ = s => document.querySelector(s);
  const API = (new URLSearchParams(location.search).get('api')||'').replace(/\/$/,'');
  const tbody = document.querySelector('#items tbody');
  function addRow(n='Консультаційні послуги',q='1',u='se',p='1200'){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input class="name" value="${n}"></td>
      <td><input class="qty" type="number" step="0.01" value="${q}"></td>
      <td><input class="unit" value="${u}"></td>
      <td><input class="price" type="number" step="0.01" value="${p}"></td>
      <td><button class="secondary del">x</button></td>`;
    tr.querySelector('.del').onclick = ()=>tr.remove();
    tbody.appendChild(tr);
  }
  addRow(); addRow('Реклама','1','se','500');

  function collectItems(){
    return [...tbody.querySelectorAll('tr')].map(tr=>({
      name: tr.querySelector('.name').value.trim(),
      qty:  tr.querySelector('.qty').value || '1',
      unit: tr.querySelector('.unit').value || 'se',
      price:tr.querySelector('.price').value || '0'
    })).filter(i=>i.name);
  }
  function setToast(ok,msg){
    $('#result').classList.remove('hidden');
    $('#toast').classList.toggle('ok',!!ok);
    $('#toast').classList.toggle('err',!ok);
    $('#toast').textContent = msg;
  }

  $('#save').onclick = async ()=>{
    try{
      if(!API) throw new Error('Не задано ?api=');
      const body={ invoice:{ currency: $('#currency').value }, buyer:{ name: $('#buyer_name').value.trim() }, items: collectItems() };
      const r = await fetch(API+'/api/invoices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok) throw new Error('API '+r.status);
      const res = await r.json();
      setToast(true, `Збережено. № ${res.number}. Сума: ${res.total}`);

      // HTML відкриття
      const addSkip = u => u + (u.includes('?')?'&':'?') + 'ngrok-skip-browser-warning=1';
      $('#btnHtml').onclick = ()=> (tg?.openLink ? tg.openLink(addSkip(res.public_url)) : window.open(addSkip(res.public_url),'_blank'));

      // PDF відкриття через проміжну сторінку API (більше не буде вітальної сторінки ngrok)
      const openPdfUrl = res.pdf_open_url || addSkip(res.pdf_url);
      $('#btnPdf').onclick = ()=> (tg?.openLink ? tg.openLink(openPdfUrl) : window.open(openPdfUrl,'_blank'));

      $('#btnNew').onclick = ()=> location.reload();

      // опц: повідомити бота
      try{ tg?.sendData && tg.sendData(JSON.stringify({type:'invoice_created', id:res.id, number:res.number})); }catch(_){}
    }catch(e){ setToast(false,'Помилка збереження: '+e.message); }
  };
})();
</script>
</body>
</html>
