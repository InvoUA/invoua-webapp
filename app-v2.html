<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–∞—Ö—É–Ω–∫—É</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; margin: 0; padding: 16px; background:#f7f7f8; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); max-width:900px; margin:0 auto; }
    h1 { margin:0 0 12px 0; font-size:20px; }
    fieldset { border:1px solid #eee; border-radius:10px; margin:12px 0; padding:12px; }
    legend { padding:0 6px; color:#555; }
    .row { display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
    label { display:block; font-size:12px; color:#555; margin-bottom:4px; }
    input, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #eee; padding:8px; }
    tfoot td { border:none; }
    .btn { background:#111; color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:#0a7cff; }
    .muted { color:#777; font-size:12px; }
    .links a { display:inline-block; margin-right:10px; }
  </style>
  <script src="./webapp_bridge.js"></script>
</head>
<body>
  <div class="card">
    <h1>–ù–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫</h1>

    <fieldset>
      <legend>–ü—Ä–æ–¥–∞–≤–µ—Ü—å</legend>
      <div class="row">
        <div><label>–ù–∞–∑–≤–∞</label><input id="seller_name"></div>
        <div><label>–ú—ñ—Å—Ç–æ/–∞–¥—Ä–µ—Å–∞</label><input id="seller_addr"></div>
        <div><label>IBAN</label><input id="seller_iban"></div>
        <div><label>–Ñ–î–†–ü–û–£/–Ü–ü–ù</label><input id="seller_tax"></div>
        <div><label>Email</label><input id="seller_email"></div>
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="seller_phone"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>–ü–æ–∫—É–ø–µ—Ü—å</legend>
      <div class="row">
        <div><label>–ù–∞–∑–≤–∞</label><input id="buyer_name"></div>
        <div><label>–ê–¥—Ä–µ—Å–∞</label><input id="buyer_addr"></div>
        <div><label>–Ñ–î–†–ü–û–£/–Ü–ü–ù</label><input id="buyer_tax"></div>
        <div><label>Email</label><input id="buyer_email"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>–ü–æ–∑–∏—Ü—ñ—ó</legend>
      <table id="items">
        <thead><tr><th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th><th>–ö-—Å—Ç—å</th><th>–û–¥.</th><th>–¶—ñ–Ω–∞</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn secondary" onclick="addRow()">+ –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
      <div class="muted" style="margin-top:6px">–§–æ—Ä–º–∞—Ç —Ü—ñ–Ω–∏: 1234,56</div>
    </fieldset>

    <fieldset>
      <legend>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</legend>
      <div class="row">
        <div><label>–í–∞–ª—é—Ç–∞</label>
          <select id="currency">
            <option value="UAH">UAH</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div><label>–ö–æ–º–µ–Ω—Ç–∞—Ä (–ø—Ä–∏–º—ñ—Ç–∫–∏)</label><input id="notes"></div>
        <div><label>–ú—ñ—Å—Ç–æ –≤–∏–ø–∏—Å–∫–∏</label><input id="place_city" placeholder="–ö–∏—ó–≤"></div>
      </div>
    </fieldset>

    <div style="display:flex; gap:8px; align-items:center; margin-top:10px">
      <button class="btn" onclick="createInvoice()">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫</button>
      <span id="status" class="muted"></span>
    </div>

    <div id="links" class="links" style="margin-top:10px"></div>
  </div>

<script>
function addRow(name="", qty="1", unit="—à—Ç", price="0,00") {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${name}"></td>
    <td><input value="${qty}" style="width:80px"></td>
    <td><input value="${unit}" style="width:80px"></td>
    <td><input value="${price}" style="width:120px"></td>
    <td><button class="btn" onclick="this.closest('tr').remove()">√ó</button></td>`;
  document.querySelector('#items tbody').appendChild(tr);
}
addRow();

async function createInvoice() {
  const status = document.getElementById('status');
  status.textContent = "–ù–∞–¥—Å–∏–ª–∞—é –¥–∞–Ω—ñ‚Ä¶";

  const items = [...document.querySelectorAll('#items tbody tr')].map(tr => {
    const tds = tr.querySelectorAll('input');
    return { name: tds[0].value, qty: tds[1].value, unit: tds[2].value, price: tds[3].value };
  });

  const payload = {
    seller: {
      name: document.getElementById('seller_name').value,
      address: document.getElementById('seller_addr').value,
      iban: document.getElementById('seller_iban').value,
      tax_id: document.getElementById('seller_tax').value,
      email: document.getElementById('seller_email').value,
      phone: document.getElementById('seller_phone').value
    },
    buyer: {
      name: document.getElementById('buyer_name').value,
      address: document.getElementById('buyer_addr').value,
      tax_id: document.getElementById('buyer_tax').value,
      email: document.getElementById('buyer_email').value
    },
    items,
    invoice: {
      currency: document.getElementById('currency').value,
      notes: document.getElementById('notes').value,
      place_city: document.getElementById('place_city').value
    }
  };

  const api = (window.API_BASE || "").replace(/\/+$/,'');
  if (!api) { status.textContent = "API_BASE –Ω–µ –∑–∞–¥–∞–Ω–∏–π (webapp_bridge.js)."; return; }

  try {
    const r = await fetch(api + "/api/invoices", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error("HTTP " + r.status);
    const data = await r.json();

    const links = data.links || {};
    const id = data.id;
    const pdf = links.pdf ? (api + links.pdf) : (api + `/api/invoices/${id}/pdf?dl=1`);
    const html = links.html ? (api + links.html) : (api + `/api/invoices/${id}/html`);

    const linksBox = document.getElementById('links');
    linksBox.innerHTML = `
      <a class="btn" href="${pdf}" target="_blank">‚¨áÔ∏è PDF</a>
      <a class="btn secondary" href="${html}" target="_blank">üîé HTML</a>
    `;
    status.textContent = "–ì–æ—Ç–æ–≤–æ!";
  } catch (e) {
    status.textContent = "–ü–æ–º–∏–ª–∫–∞: " + e.message;
  }
}
</script>
</body>
</html>
