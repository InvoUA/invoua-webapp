<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>InvoUA — форма інвойсу</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { display:block; font-size:12px; color:#555; margin-bottom:4px }
    input, textarea { width:100%; box-sizing:border-box; padding:10px; border:1px solid #ddd; border-radius:8px; }
    textarea { min-height:80px; resize:vertical; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    .btn { display:inline-block; padding:10px 14px; border-radius:10px; border:0; background:#0d6efd; color:#fff; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:#666; font-size:12px }
    .ok { color:#0a7d1a; }
    .err { color:#b00020; white-space:pre-wrap }
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
  </style>
  <script src="./webapp_env.js"></script>
  <script>
    // Fallback, якщо файл webapp_env.js ще не підписали
    if (!window.API_BASE) window.API_BASE = (new URLSearchParams(location.search).get('api')) || "http://127.0.0.1:8081";
    if (!window.APP_BASE) window.APP_BASE = (new URLSearchParams(location.search).get('app')) || location.origin;

    // Telegram bridge (надсилання даних у бота)
    (function(){
      const tg = window.Telegram && window.Telegram.WebApp;
      function sendToBot(payload){
        try { tg && tg.sendData && tg.sendData(JSON.stringify(payload)); } catch(e){}
      }
      // перехоплюємо fetch POST /api/invoices -> шлемо tg.sendData
      const oFetch = window.fetch;
      window.fetch = async function(input, init){
        const res = await oFetch(input, init);
        try {
          const url = (typeof input==='string')?input:(input && input.url)||'';
          const method = (init && init.method || 'GET').toUpperCase();
          if (/\/api\/invoices(\?|$)/i.test(url) && method==='POST' && res.ok){
            const clone = res.clone();
            const data = await clone.json().catch(()=>null);
            if (data && data.id){
              sendToBot({type:'invoice_created', id:data.id, number:data.number, pdf_url:data.pdf_url, public_url:data.public_url});
            }
          }
        } catch(e){}
        return res;
      };
    })();
  </script>
</head>
<body>
  <h1>Створення інвойсу</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>ПЛАТНИК (payer)</label>
        <input id="payer" placeholder="ТОВ «Клієнт», ЄДРПОУ…, адреса…" />
      </div>
      <div>
        <label>ОТРИМУВАЧ (beneficiary)</label>
        <input id="benef" placeholder="ФОП / ТОВ, ЄДРПОУ/РНОКПП…, IBAN…" />
      </div>
    </div>

    <div class="mt12">
      <label>РЕКВІЗИТИ (details)</label>
      <textarea id="details" placeholder="Банк, МФО, IBAN, призначення платежу за замовчуванням…"></textarea>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>СУМА (UAH, кома)</label>
        <input id="amount" placeholder="1234,56" />
      </div>
      <div>
        <label>СТРОК ОПЛАТИ (днів)</label>
        <input id="due_days" type="number" value="5" />
      </div>
    </div>
    <div class="mt12">
      <label>ОПИС (description)</label>
      <textarea id="desc" placeholder="Послуги за… період …, акт №…"></textarea>
    </div>
  </div>

  <button id="btn" class="btn">Створити і отримати PDF</button>
  <div id="status" class="mt12 muted"></div>
  <div id="links" class="mt12"></div>

  <script>
    const btn = document.getElementById('btn');
    const statusEl = document.getElementById('status');
    const linksEl = document.getElementById('links');

    function setStatus(msg, cls) {
      statusEl.className = 'mt12 ' + (cls || 'muted');
      statusEl.textContent = msg;
    }

    async function createInvoice() {
      const payload = {
        payer:  document.getElementById('payer').value.trim(),
        beneficiary: document.getElementById('benef').value.trim(),
        details: document.getElementById('details').value.trim(),
        amount: document.getElementById('amount').value.trim(),
        due_days: Number(document.getElementById('due_days').value || 0),
        description: document.getElementById('desc').value.trim()
      };

      if (!payload.amount) { setStatus("Вкажіть суму.", "err"); return; }
      setStatus("Створюю…");

      try {
        const res = await fetch(`${window.API_BASE}/api/invoices`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': '1',
            'User-Agent': 'invoua-web'
          },
          body: JSON.stringify(payload),
          redirect: 'follow'
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(`HTTP ${res.status}: ${t}`);
        }
        const data = await res.json();

        const pdf = data.pdf_url || `${window.API_BASE}/api/invoices/${data.id}/pdf?dl=1`;
        const html = data.public_url || `${window.APP_BASE}/app-v2.html`;

        linksEl.innerHTML = `
          <div class="ok mt8">✅ Створено. ID: ${data.id}</div>
          <div class="mt8"><a class="btn" href="${pdf}" target="_blank" rel="noopener">Відкрити PDF</a></div>
        `;
        setStatus("Готово.", "ok");
      } catch (e) {
        setStatus(`Помилка: ${e}`, "err");
      }
    }

    btn.addEventListener('click', createInvoice);
  </script>
</body>
</html>
