<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>InvoUA — рахунок за 60 секунд / v2.4</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;font-size:14px;margin:16px;max-width:1200px}
    h1{margin:0 0 8px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input,select,button{font:inherit;padding:8px;border:1px solid #ccc;border-radius:6px;width:100%}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #ddd;padding:6px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .note{color:#666;font-size:12px;margin-top:6px}
    .err{color:#c00}
    .ok{color:#080}
  </style>
</head>
<body>
<h1>InvoUA — рахунок за 60 секунд <small>/ v2.4</small></h1>

<div class="row">
  <div class="col">
    <h3>Продавець</h3>
    <label>Назва <input id="s_name"></label>
    <label>IBAN <input id="s_iban"></label>
    <label>Адреса <input id="s_addr"></label>
    <label>Телефон <input id="s_phone"></label>
    <label>ЄДРПОУ/ІПН <input id="s_tax"></label>
    <label>Банк <input id="s_bank"></label>
    <label>Email <input id="s_email"></label>
    <label>Лого URL <input id="s_logo"></label>
    <label>Підпис URL <input id="s_sign"></label>
    <div class="actions"><button id="btnSaveSeller">Зберегти продавця</button></div>
  </div>

  <div class="col">
    <h3>Рахунок</h3>
    <label>Покупець (назва/ПІБ) <input id="b_name"></label>
    <label>Валюта
      <select id="inv_curr">
        <option>UAH</option><option>USD</option><option>EUR</option>
      </select>
    </label>
  </div>
</div>

<h3>Найменування</h3>
<table id="tbl">
  <thead>
  <tr><th>#</th><th>Назва</th><th>К-сть</th><th>Од.</th><th>Ціна</th><th></th></tr>
  </thead>
  <tbody></tbody>
</table>

<div class="actions">
  <button id="btnAdd">+ Додати позицію</button>
  <button id="btnSave">Зберегти рахунок</button>
  <button id="btnOpenSrv">Відкрити PDF (сервер)</button>
  <button id="btnOpenHtml">Відкрити HTML</button>
  <button id="btnLocal">Завантажити PDF (локально)</button>
  <button id="btnNew">Новий</button>
</div>

<div id="msg" class="note"></div>
<div class="note">API-адреса береться з параметра <b>?api=</b>. Якщо працюєш через ngrok — ми додаємо <code>ngrok-skip-browser-warning=1</code> автоматично.</div>

<script>
// ---- Wipe mode ----
(async function wipeIfAsked(){
  const qs = new URLSearchParams(location.search);
  if (!qs.has('wipe') && !qs.has('wipe_fonts')) return;

  try {
    if (window.caches && caches.keys) {
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n).catch(()=>{})));
    }
    if (self.indexedDB && indexedDB.databases) {
      const dbs = await indexedDB.databases();
      await Promise.all((dbs||[]).map(d => new Promise(res=>{
        const req = indexedDB.deleteDatabase(d.name); req.onsuccess = req.onerror = req.onblocked = ()=>res();
      })));
    }
    try { localStorage.clear(); } catch(_){}
    try { sessionStorage.clear(); } catch(_){}
  } catch(e) { console.warn('Wipe error:', e); }

  qs.delete('wipe'); qs.delete('wipe_fonts');
  if (!qs.has('v')) qs.set('v', Date.now());
  location.replace(location.pathname + '?' + qs.toString());
})();

// ==== helpers ====
const $ = sel => document.querySelector(sel);
const tbody = $("#tbl tbody");
let lastInvoice = null;  // {id, number, public_url, pdf_url, pdf_open_url}
let lastDocId = null;

function apiBase(){
  const api = new URLSearchParams(location.search).get("api") || "";
  if(!api){ throw new Error("Не задано ?api= у URL"); }
  return api.replace(/\/+$/,''); // без хвоста /
}
function apiUrl(path){
  const base = apiBase();
  const url = base + (path.startsWith("/")? path : "/"+path);
  return url + (url.includes("?") ? "&" : "?") + "ngrok-skip-browser-warning=1";
}
function msg(txt, ok=false){
  const el = $("#msg");
  el.className = "note " + (ok ? "ok" : "err");
  el.textContent = txt;
}

// рядок у таблиці
function addRow(it={name:"",qty:1,unit:"se",price:0}){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="idx"></td>
    <td><input class="nm" value="${it.name||""}"></td>
    <td><input class="qty" type="number" step="0.01" value="${it.qty||0}"></td>
    <td><input class="unit" value="${it.unit||"se"}"></td>
    <td><input class="price" type="number" step="0.01" value="${it.price||0}"></td>
    <td><button class="rm">x</button></td>`;
  tr.querySelector(".rm").onclick = ()=>{ tr.remove(); renumber(); };
  tbody.appendChild(tr);
  renumber();
}
function renumber(){
  [...tbody.querySelectorAll("tr")].forEach((tr,i)=> tr.querySelector(".idx").textContent = (i+1));
}
function collectItems(){
  return [...tbody.querySelectorAll("tr")].map(tr=>{
    return {
      name: tr.querySelector(".nm").value.trim(),
      qty: parseFloat(tr.querySelector(".qty").value||0),
      unit: tr.querySelector(".unit").value.trim()||"se",
      price: parseFloat(tr.querySelector(".price").value||0)
    };
  });
}
function sellerFromForm(){
  return {
    name: $("#s_name").value.trim(),
    iban: $("#s_iban").value.trim(),
    address: $("#s_addr").value.trim(),
    phone: $("#s_phone").value.trim(),
    tax_id: $("#s_tax").value.trim(),
    bank: $("#s_bank").value.trim(),
    email: $("#s_email").value.trim(),
    logo_url: $("#s_logo").value.trim(),
    sign_url: $("#s_sign").value.trim()
  };
}
function fillSeller(s){
  $("#s_name").value = s.name||"";
  $("#s_iban").value = s.iban||"";
  $("#s_addr").value = s.address||"";
  $("#s_phone").value = s.phone||"";
  $("#s_tax").value = s.tax_id||"";
  $("#s_bank").value = s.bank||"";
  $("#s_email").value = s.email||"";
  $("#s_logo").value = s.logo_url||"";
  $("#s_sign").value = s.sign_url||"";
}

// ==== API calls ====
async function loadSeller(){
  const r = await fetch(apiUrl("/api/seller"), {credentials:"omit"});
  if(!r.ok) throw new Error("GET /seller failed");
  const s = await r.json();
  fillSeller(s||{});
}
async function saveSeller(){
  const r = await fetch(apiUrl("/api/seller"), {
    method:"PUT", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(sellerFromForm())
  });
  if(!r.ok) throw new Error("PUT /seller failed");
  msg("Продавця збережено", true);
}
async function saveInvoice(){
  const body = {
    invoice: { number: "INV-" + new Date().toISOString().replace(/\D/g,'').slice(0,14), currency: $("#inv_curr").value },
    seller: sellerFromForm(),
    buyer: { name: $("#b_name").value.trim() },
    items: collectItems()
  };
  const r = await fetch(apiUrl("/api/invoices"), {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
  });
  if(!r.ok){
    const t = await r.text().catch(()=>r.statusText);
    throw new Error("Помилка збереження: " + (t||r.statusText));
  }
  const j = await r.json();
  lastInvoice = j; lastDocId = j.id;
  return j;
}
async function getInvoiceJson(id){
  const r = await fetch(apiUrl(`/api/invoices/${encodeURIComponent(id)}`));
  if(!r.ok){
    const t = await r.text().catch(()=>r.statusText);
    throw new Error("Очікував JSON, отримав: " + (t||r.statusText));
  }
  // безпечний парсер
  const txt = await r.text();
  try{ return JSON.parse(txt); }
  catch(e){ throw new Error(`Unexpected JSON error: ${txt.slice(0,180)}`); }
}

// ==== Local PDF (jsPDF + DejaVu) ====
async function loadFontB64(url){
  const v = Date.now(); // bust cache
  const r = await fetch(url + (url.includes("?")?"&":"?") + "v=" + v, {mode:"cors"});
  if(!r.ok) throw new Error("Font fetch failed: " + url);
  const ab = await r.arrayBuffer();
  let binary = "";
  const bytes = new Uint8Array(ab);
  for (let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
async function downloadLocalPDF(){
  try{
    if(!lastDocId){ await saveInvoice(); }
    const doc = await getInvoiceJson(lastDocId);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:"pt", format:"a4"});

    // fonts
    const base = location.origin + location.pathname.replace(/\/[^\/]*$/,"");
    const root = "https://invoua.github.io/invoua-webapp"; // де лежать шрифти
    const dejavu = await loadFontB64(`${root}/fonts/DejaVuSans.ttf`);
    const dejavuB = await loadFontB64(`${root}/fonts/DejaVuSans-Bold.ttf`);
    pdf.addFileToVFS("DejaVuSans.ttf", dejavu);
    pdf.addFileToVFS("DejaVuSans-Bold.ttf", dejavuB);
    pdf.addFont("DejaVuSans.ttf", "DejaVu", "normal");
    pdf.addFont("DejaVuSans-Bold.ttf", "DejaVu", "bold");
    pdf.setFont("DejaVu", "bold");
    pdf.setFontSize(16);

    let x=40, y=50;
    pdf.text(`Рахунок # ${doc.invoice?.number||""}`, x, y); y+=18;
    pdf.setFont("DejaVu", "normal"); pdf.setFontSize(11);
    pdf.text(`Дата: ${doc.invoice?.issue_date_human || doc.invoice?.issue_date || ""}`, x, y); y+=16;
    pdf.text(`Покупець: ${doc.buyer?.name||""}`, x, y); y+=16;
    pdf.text(`Сума до оплати: ${doc.invoice?.total||0} ${doc.invoice?.currency||"UAH"}`, x, y); y+=24;

    pdf.setFont("DejaVu", "bold"); pdf.text("Позиції:", x, y); y+=16; pdf.setFont("DejaVu","normal");
    (doc.items||[]).forEach((it,i)=>{
      const line = `${i+1}. ${it.name||""} — ${it.qty||0} ${it.unit||""} × ${it.price||0} = ${it.line_total||0}`;
      pdf.text(line, x, y); y+=14; if(y>780){ pdf.addPage(); y=50; }
    });

    pdf.save(`invoice_${lastDocId}.pdf`);
    msg("PDF (локально) збережено", true);
  }catch(e){
    console.error(e);
    msg("Помилка локального PDF: " + e.message);
  }
}

// ==== UI ====
$("#btnAdd").onclick = ()=> addRow();
$("#btnSaveSeller").onclick = ()=> saveSeller().catch(e=>msg(e.message));
$("#btnSave").onclick = async ()=>{
  try{
    const r = await saveInvoice();
    msg("Рахунок збережено", true);
  }catch(e){ msg(e.message); }
};
$("#btnOpenHtml").onclick = async ()=>{
  if(!lastInvoice){ await $("#btnSave").onclick(); }
  if(lastInvoice?.public_url){ open(lastInvoice.public_url, "_blank"); }
};
$("#btnOpenSrv").onclick = async ()=>{
  if(!lastInvoice){ await $("#btnSave").onclick(); }
  if(lastInvoice?.pdf_open_url){ open(lastInvoice.pdf_open_url, "_blank"); }
};
$("#btnLocal").onclick = ()=> downloadLocalPDF();
$("#btnNew").onclick = async ()=>{
  tbody.innerHTML = ""; addRow();
  try{ await loadSeller(); }catch{}
  lastInvoice = null; lastDocId = null; msg("Нова форма готова", true);
};

// init
(async ()=>{
  try{
    addRow({name:"Консультаційні послуги",qty:1,unit:"se",price:1200});
    addRow({name:"Реклама",qty:1,unit:"se",price:500});
    await loadSeller();
  }catch(e){
    msg("Помилка ініціалізації: " + e.message);
  }
})();
</script>

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</body>
</html>
