<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Створити рахунок (InvoUA)</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --ink:#e7ecf3; --muted:#9fb0c3; --accent:#4cc9f0; --danger:#ff6b6b; --ok:#2ecc71; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:980px;margin:auto;padding:16px}
    .card{background:var(--card);border-radius:16px;padding:16px 16px 8px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    h1{margin:0 0 8px;font-size:20px}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select{width:100%;padding:10px;border:1px solid #22314a;background:#0c1526;color:var(--ink);border-radius:10px;outline:none}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#00121f;border:none;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1c2a44;color:var(--ink)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .status{font-size:12px}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}
    .links a{color:var(--accent);text-decoration:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e1b2d;color:var(--muted);font-size:12px}
    .caption{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:#1d2940;margin:8px 0 4px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1d2940}
    th{color:var(--muted);font-weight:600;text-align:left}
    .right{text-align:right}
  </style>

  <!-- 1) Оточення з кореня: ставить window.API_BASE / window.APP_BASE -->
  <script src="/webapp_env.js"></script>
  <!-- 2) Міст для Telegram WebApp (лежить поряд із цим файлом) -->
  <script src="./webapp_tg_bridge.js"></script>

  <script>
    // Фолбеки: беремо з webapp_env.js, або з query (?api=...), або з origin
    function pickApiBase(){
      if (window.API_BASE && /^https?:\/\//i.test(window.API_BASE)) return window.API_BASE.replace(/\/$/,'');
      const m = location.search.match(/[?&]api=([^&]+)/i);
      if (m) return decodeURIComponent(m[1]).replace(/\/$/,'');
      return location.origin;
    }
    function pickAppBase(){
      if (window.APP_BASE && /^https?:\/\//i.test(window.APP_BASE)) return window.APP_BASE.replace(/\/$/, '');
      return location.origin;
    }
    const BRIDGE = { API_BASE: pickApiBase(), APP_BASE: pickAppBase() };

    // Фікс для splash від ngrok у Telegram WebView:
    const NGROK_HEADERS = { 'ngrok-skip-browser-warning': 'true' };

    async function pingApi(){
      const s = document.getElementById('api-status');
      s.textContent = 'перевірка...';
      s.className = 'status muted';
      try{
        const r = await fetch(`${BRIDGE.API_BASE}/health`, { headers: NGROK_HEADERS, credentials:'omit' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        await r.json().catch(()=> ({}));
        s.textContent = `OK (${BRIDGE.API_BASE})`;
        s.className = 'status ok';
        return true;
      }catch(e){
        s.textContent = `Немає доступу до API (${BRIDGE.API_BASE})`;
        s.className = 'status bad';
        return false;
      }
    }

    async function createInvoice(e){
      e.preventDefault();
      const btn = document.getElementById('submit');
      btn.disabled = true;

      if (!await pingApi()){ btn.disabled = false; return; }

      const f = document.forms.invoiceForm;

      // збираємо позиції (до 3 для прикладу)
      const items = [];
      for (let i=0;i<3;i++){
        const name = f[`item_name_${i}`].value.trim();
        const qty  = f[`item_qty_${i}`].value.trim();
        const unit = f[`item_unit_${i}`].value.trim();
        const price= f[`item_price_${i}`].value.trim();
        if (!name) continue;
        items.push({ name, qty: qty||'1', unit: unit||'шт', price: price||'0' });
      }
      if (!items.length){
        alert('Додайте хоча б одну позицію'); btn.disabled = false; return;
      }

      const payload = {
        seller: {
          name:   f.seller_name.value.trim(),
          address:f.seller_addr.value.trim(),
          iban:   f.seller_iban.value.trim(),
          tax_id: f.seller_tax.value.trim(),
          email:  f.seller_email.value.trim(),
          phone:  f.seller_phone.value.trim()
        },
        buyer: {
          name:   f.buyer_name.value.trim(),
          address:f.buyer_addr.value.trim(),
          tax_id: f.buyer_tax.value.trim(),
          email:  f.buyer_email.value.trim(),
          phone:  f.buyer_phone.value.trim()
        },
        items,
        invoice:{
          currency: f.currency.value || 'UAH',
          notes:    f.notes.value.trim(),
          place_city: f.place_city.value.trim()
        }
      };

      let data;
      try{
        const r = await fetch(`${BRIDGE.API_BASE}/api/invoices`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json; charset=utf-8', ...NGROK_HEADERS },
          body: JSON.stringify(payload),
          credentials:'omit'
        });
        if (!r.ok){
          const t = await r.text().catch(()=> '');
          throw new Error(`HTTP ${r.status}: ${t||'помилка'}`);
        }
        data = await r.json();
      }catch(err){
        alert('Не вдалося створити рахунок:\n' + err.message);
        btn.disabled = false; return;
      }

      const links = document.getElementById('links');
      links.innerHTML = '';

      const htmlUrl = data.public_url || `${BRIDGE.API_BASE}/api/invoices/${encodeURIComponent(data.id)}/html`;
      let   pdfUrl  = data.pdf_url    || `${BRIDGE.API_BASE}/api/invoices/${encodeURIComponent(data.id)}/pdf`;
      if (!/[?&]dl=1\b/.test(pdfUrl)) pdfUrl += (pdfUrl.includes('?')?'&':'?') + 'dl=1';

      const aHtml = document.createElement('a');
      aHtml.href = htmlUrl; aHtml.target = '_blank'; aHtml.textContent = 'Відкрити HTML-рахунок';

      const aPdf  = document.createElement('a');
      aPdf.href  = pdfUrl;  aPdf.target  = '_blank'; aPdf.textContent  = 'Завантажити PDF';

      links.appendChild(Object.assign(document.createElement('div'),{appendChild: d=> (d,aHtml), innerHTML:''})); // no-op для IE
      links.appendChild(document.createElement('div')).appendChild(aHtml);
      links.appendChild(document.createElement('div')).appendChild(aPdf);

      // Автовідкриття PDF у Telegram WebView:
      try{ window.open(pdfUrl, '_blank'); }catch(e){}

      btn.disabled = false;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('api-base').textContent = BRIDGE.API_BASE;
      document.getElementById('app-base').textContent = BRIDGE.APP_BASE;
      pingApi();
      document.getElementById('invoiceForm').addEventListener('submit', createInvoice);
      document.getElementById('btnPing').addEventListener('click', (e)=>{ e.preventDefault(); pingApi(); });
    });
  </script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Створення рахунку</h1>
      <div class="row" style="justify-content:space-between">
        <div class="pill">APP_BASE: <span id="app-base">—</span></div>
        <div class="status" id="api-status">перевірка...</div>
      </div>
      <div class="caption">API_BASE: <span id="api-base">—</span> · <a href="#" id="btnPing" class="links">Перевірити API</a></div>
      <div class="hr"></div>

      <form id="invoiceForm" class="grid">
        <div class="grid grid-2">
          <div>
            <label>Продавець</label>
            <input name="seller_name" placeholder="Назва / ПІБ" />
            <input name="seller_addr" placeholder="Адреса" />
            <div class="row">
              <input name="seller_iban" placeholder="IBAN" />
              <input name="seller_tax" placeholder="ЄДРПОУ/ІПН" />
            </div>
            <div class="row">
              <input name="seller_email" placeholder="Email" />
              <input name="seller_phone" placeholder="Телефон" />
            </div>
          </div>
          <div>
            <label>Покупець</label>
            <input name="buyer_name" placeholder="Назва / ПІБ" />
            <input name="buyer_addr" placeholder="Адреса" />
            <div class="row">
              <input name="buyer_tax" placeholder="ЄДРПОУ/ІПН" />
              <input name="buyer_email" placeholder="Email" />
            </div>
            <input name="buyer_phone" placeholder="Телефон" />
          </div>
        </div>

        <div>
          <label>Позиції (до 3 для прикладу)</label>
          <table>
            <thead><tr><th>Найменування</th><th>К-сть</th><th>Од.</th><th class="right">Ціна</th></tr></thead>
            <tbody>
              <tr>
                <td><input name="item_name_0" placeholder="Послуга/Товар" /></td>
                <td style="width:90px"><input name="item_qty_0" value="1" /></td>
                <td style="width:90px"><input name="item_unit_0" value="шт" /></td>
                <td style="width:150px"><input name="item_price_0" placeholder="1000,00" /></td>
              </tr>
              <tr>
                <td><input name="item_name_1" /></td>
                <td><input name="item_qty_1" value="1" /></td>
                <td><input name="item_unit_1" value="шт" /></td>
                <td><input name="item_price_1" /></td>
              </tr>
              <tr>
                <td><input name="item_name_2" /></td>
                <td><input name="item_qty_2" value="1" /></td>
                <td><input name="item_unit_2" value="шт" /></td>
                <td><input name="item_price_2" /></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="grid grid-2">
          <div>
            <label>Валюта</label>
            <select name="currency">
              <option>UAH</option>
              <option>USD</option>
              <option>EUR</option>
            </select>
          </div>
          <div>
            <label>Місто складання</label>
            <input name="place_city" placeholder="Київ" />
          </div>
        </div>

        <div>
          <label>Нотатки (необовʼязково)</label>
          <textarea name="notes" placeholder="Без ПДВ / реквізити тощо"></textarea>
        </div>

        <div class="row" style="justify-content:flex-end">
          <button id="submit" class="btn">Створити рахунок</button>
          <button type="button" class="btn secondary" onclick="pingApi()">Перевірити API</button>
        </div>

        <div class="links" id="links" style="margin:8px 0 4px"></div>
      </form>
    </div>
  </div>
</body>
</html>
