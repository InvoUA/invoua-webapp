<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InvoUA — Створити рахунок</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:20px; }
    .card { max-width: 900px; margin: 0 auto; background: rgb(28 28 30 / .05); padding: 20px; border-radius: 16px; }
    h1 { margin-top:0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; }
    label { display:block; font-size: 12px; opacity:.75; margin: 8px 0 4px; }
    input, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgb(120 120 120 / .25); background: transparent;
      font-size: 16px;
    }
    textarea { resize: vertical; min-height: 64px; }
    .btn { display:inline-block; padding: 10px 16px; border-radius: 10px; border: 0; background: #2b7cff; color:#fff; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #444; }
    .muted { font-size:12px; opacity:.7; }
    .notice { margin: 8px 0 0; font-size: 12px; }
    .ok { color: #1a7f37; }
    .err { color: #c62828; }
    .grid { display:grid; gap: 12px; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .right { text-align:right; }
    .hidden { display:none; }
    .api-line { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
  </style>

  <!-- ====== INLINE ENV (без зовнішнього webapp_env.js) ====== -->
  <script>
    // Значення оновлює start_all.ps1 автоматично:
    window.API_BASE = "https://REPLACE_API.ngrok-free.app";
    window.APP_BASE = "https://REPLACE_WEB.ngrok-free.app";

    // Додаємо заголовок до УСІХ fetch/XHR, щоб не було екрану ngrok
    window.__NGROK_HEADERS__ = { "ngrok-skip-browser-warning": "1", "User-Agent": "invoua" };

    (function patchRequests() {
      const origFetch = window.fetch;
      if (origFetch) {
        window.fetch = (input, init) => {
          init = init || {};
          init.headers = Object.assign({}, init && init.headers || {}, window.__NGROK_HEADERS__);
          return origFetch(input, init);
        };
      }
      const XHR = window.XMLHttpRequest;
      if (XHR) {
        const open = XHR.prototype.open;
        const send = XHR.prototype.send;
        XHR.prototype.open = function(m,u){ this.__m=m; this.__u=u; return open.apply(this,arguments); };
        XHR.prototype.send = function(b){
          try {
            this.setRequestHeader("ngrok-skip-browser-warning","1");
            this.setRequestHeader("User-Agent","invoua");
          } catch(e){}
          return send.apply(this,arguments);
        };
      }
    })();

    // Telegram WebApp bridge: відправимо дані боту після створення
    (function tgBridge(){
      const tg = window.Telegram && window.Telegram.WebApp;
      function send(payload){ try { tg && tg.sendData && tg.sendData(JSON.stringify(payload)); } catch (e){} }
      window.__notify_bot__ = function (data) {
        if (data && data.id) {
          const pdf = `${window.API_BASE}/api/invoices/${data.id}/pdf?dl=1`;
          send({ type:"invoice_created", id:data.id, number:(data.invoice && data.invoice.number)||data.id,
                 html_url: `${window.API_BASE}/api/invoices/${data.id}/html`,
                 pdf_url: pdf });
        }
      };
    })();
  </script>
  <!-- ======================================================== -->
</head>
<body>
  <div class="card">
    <h1>Створити рахунок</h1>

    <div id="apiStatus" class="api-line muted">
      API: <span id="apiUrl"></span> • <span id="apiPing" class="err">перевіряю…</span>
    </div>

    <form id="f" class="grid">
      <div class="row">
        <div>
          <label>Продавець — Назва</label>
          <input id="seller_name" placeholder="ТОВ Ромашка" />
        </div>
        <div>
          <label>Покупець — Назва</label>
          <input id="buyer_name" placeholder="ТОВ Васильок" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Адреса продавця</label>
          <input id="seller_addr" placeholder="Київ" />
        </div>
        <div>
          <label>Адреса покупця</label>
          <input id="buyer_addr" placeholder="Львів" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>IBAN продавця</label>
          <input id="seller_iban" placeholder="UA..." />
        </div>
        <div>
          <label>ЄДРПОУ/ІПН продавця</label>
          <input id="seller_tax" placeholder="12345678" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Email продавця</label>
          <input id="seller_email" placeholder="test@example.com" />
        </div>
        <div>
          <label>Телефон продавця</label>
          <input id="seller_phone" placeholder="+380..." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Валюта</label>
          <select id="currency">
            <option>UAH</option>
            <option>USD</option>
            <option>EUR</option>
            <option>PLN</option>
          </select>
        </div>
        <div>
          <label>Нотатки (необов’язково)</label>
          <input id="notes" placeholder="Без ПДВ / підпис/печатка" />
        </div>
      </div>

      <div class="row-3">
        <div>
          <label>Найменування</label>
          <input id="item_name" placeholder="Послуга/Товар" />
        </div>
        <div>
          <label>К-сть</label>
          <input id="item_qty" inputmode="decimal" value="1" />
        </div>
        <div>
          <label>Ціна (кома)</label>
          <input id="item_price" inputmode="decimal" placeholder="1000,00" />
        </div>
      </div>

      <div class="flex">
        <button type="submit" class="btn">Створити рахунок</button>
        <button type="button" id="demo" class="btn secondary">Швидко заповнити приклад</button>
        <span id="status" class="notice"></span>
      </div>

      <div id="links" class="hidden">
        <div class="notice">
          <a id="aPdf" target="_blank" rel="noopener">Відкрити PDF</a> •
          <a id="aHtml" target="_blank" rel="noopener">Переглянути HTML</a>
        </div>
      </div>

      <div class="muted">Використовуйте кому для копійок: 1234,56</div>
    </form>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // показати URL та перевірка
    (async function ping(){
      $("apiUrl").textContent = `${window.API_BASE}/api/invoices`;
      try {
        const r = await fetch(`${window.API_BASE}/health`);
        if (!r.ok) throw new Error(r.status);
        $("apiPing").textContent = "OK";
        $("apiPing").className = "ok";
      } catch(e){
        $("apiPing").textContent = "API недоступний";
        $("apiPing").className = "err";
      }
    })();

    $("demo").onclick = () => {
      $("seller_name").value = "ФОП Приклад";
      $("seller_addr").value = "Київ";
      $("seller_iban").value = "UA123...";
      $("seller_tax").value = "1234567890";
      $("seller_email").value = "test@example.com";
      $("seller_phone").value = "+380...";
      $("buyer_name").value = "ТОВ Замовник";
      $("buyer_addr").value = "Львів";
      $("item_name").value = "Розробка";
      $("item_qty").value = "1";
      $("item_price").value = "1000,00";
      $("notes").value = "Без ПДВ";
      $("currency").value = "UAH";
    };

    $("f").onsubmit = async (e) => {
      e.preventDefault();
      $("status").textContent = "Створюю…";
      $("status").className = "notice";

      const payload = {
        seller: {
          name: $("seller_name").value.trim(),
          address: $("seller_addr").value.trim(),
          iban: $("seller_iban").value.trim(),
          tax_id: $("seller_tax").value.trim(),
          email: $("seller_email").value.trim(),
          phone: $("seller_phone").value.trim()
        },
        buyer: {
          name: $("buyer_name").value.trim(),
          address: $("buyer_addr").value.trim()
        },
        items: [
          {
            name: $("item_name").value.trim(),
            qty: $("item_qty").value.trim() || "1",
            unit: "шт",
            price: $("item_price").value.trim()
          }
        ],
        invoice: {
          currency: $("currency").value,
          notes: $("notes").value.trim()
        }
      };

      try {
        const res = await fetch(`${window.API_BASE}/api/invoices`, {
          method: "POST",
          headers: Object.assign({ "Content-Type":"application/json" }, window.__NGROK_HEADERS__),
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const txt = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status} ${txt}`);
        }
        const data = await res.json();
        window.__notify_bot__ && window.__notify_bot__(data);

        const id = data.id;
        const pdf = `${window.API_BASE}/api/invoices/${id}/pdf?dl=1`;
        const html = `${window.API_BASE}/api/invoices/${id}/html`;

        $("aPdf").href = pdf;
        $("aHtml").href = html;
        $("links").classList.remove("hidden");

        // у Telegram iOS краще відкривати нове вікно користувачем — є кнопка вище
        $("status").textContent = `Готово: ${data.invoice?.number || id}`;
        $("status").className = "notice ok";
      } catch (err) {
        $("status").textContent = `Помилка мережі або CORS: ${String(err)}`;
        $("status").className = "notice err";
      }
    };
  </script>
</body>
</html>
