<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Створити рахунок</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 12px; background:#0b0f14; color:#e8eef6; }
    .card{ background:#111826; border-radius:14px; padding:16px; margin:0 auto; max-width:640px; box-shadow:0 8px 24px rgba(0,0,0,.35);}
    h1{ font-size:26px; margin:0 0 12px;}
    .row{ display:flex; gap:12px; margin-bottom:10px;}
    .row > div{ flex:1;}
    label{ display:block; font-size:12px; opacity:.8; margin-bottom:6px;}
    input,select,button{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3443; background:#0e141f; color:#e8eef6;}
    input::placeholder{ color:#8ba3bd;}
    .muted{ font-size:12px; color:#8ba3bd;}
    .ok{ color:#4ade80} .err{ color:#f87171}
    .toolbar{ display:flex; gap:10px; align-items:center; margin:10px 0 16px;}
    .btn{ background:#2563eb; border:none; color:#fff; font-weight:600; cursor:pointer}
    .btn.secondary{ background:#1f2937 }
    .items th, .items td{ padding:8px; border-bottom:1px solid #1f2a3a;}
    .items{ width:100%; border-collapse:collapse; margin-top:8px;}
    .footer{ margin-top:12px; font-size:12px; opacity:.8 }
    .danger{ color:#f87171; display:flex; align-items:center; gap:8px; margin-top:8px;}
    a { color:#60a5fa; }
  </style>
  <script src="webapp_env.js?v=2"></script>
  <script>
    // --- Витягуємо API_BASE/APP_BASE з env або з query (?api=...)
    (function resolveBases(){
      const qs = new URLSearchParams(location.search);
      const api = qs.get('api');
      const app = qs.get('app');
      if (api)  window.API_BASE = api.replace(/\/+$/,'');
      if (app)  window.APP_BASE = app.replace(/\/+$/,'');
      if (!window.API_BASE) window.API_BASE = (window.API_BASE || '').replace(/\/+$/,'');
      if (!window.APP_BASE) window.APP_BASE = (window.APP_BASE || location.origin).replace(/\/+$/,'');
    })();

    // --- Безпечний fetch з байпасом ngrok-віталки
    async function safeFetch(url, opts={}) {
      const headers = Object.assign(
        {"ngrok-skip-browser-warning":"1"},
        (opts.headers||{})
      );
      return fetch(url, Object.assign({}, opts, {headers}));
    }

    async function pingAPI(){
      const statusEl = document.getElementById('apiStatus');
      const url = (window.API_BASE||'') + '/health';
      statusEl.textContent = 'перевірка...';
      statusEl.className = 'muted';
      try{
        const r = await safeFetch(url);
        if (!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        statusEl.textContent = 'OK';
        statusEl.className = 'muted ok';
      }catch(e){
        statusEl.textContent = 'API недоступний';
        statusEl.className = 'muted err';
      }
      document.getElementById('apiUrl').textContent = (window.API_BASE||'') + '/api/invoices';
      document.getElementById('apiUrl').href = (window.API_BASE||'') + '/health';
    }

    function val(id){ return document.getElementById(id).value.trim(); }

    function buildPayload(){
      // Мінімальний payload для /api/invoices
      // amount обовʼязковий; решта — як у твоєму API
      const amount = val('amount') || '1000,00';
      const description = val('desc') || 'Послуги';
      const payload = {
        amount,
        description,
        seller: {
          name: val('s_name'),
          address: val('s_addr'),
          iban: val('s_iban'),
          tax_id: val('s_tax'),
          email: val('s_email'),
          phone: val('s_phone')
        },
        buyer: {
          name: val('b_name'),
          address: val('b_addr'),
          tax_id: val('b_tax'),
          email: val('b_email'),
          phone: val('b_phone')
        },
        invoice: {
          currency: val('currency') || 'UAH',
          notes: val('notes') || ''
        },
        items: [
          {
            name: val('it1_name') || 'Послуга/Товар',
            qty:  val('it1_qty')  || '1',
            unit: val('it1_unit') || 'шт',
            price: val('amount')  || '1000,00'
          }
        ]
      };
      return payload;
    }

    async function submitForm(){
      const out = document.getElementById('out');
      out.textContent = '';
      const api = (window.API_BASE||'') + '/api/invoices';
      try{
        const r = await safeFetch(api,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(buildPayload())
        });
        const text = await r.text(); // читаємо як текст (на випадок HTML від ngrok)
        if (!r.ok) throw new Error(text || ('HTTP '+r.status));
        let data;
        try { data = JSON.parse(text); } catch { throw new Error('Очікував JSON, отримав HTML (ймовірно ngrok-віталка)'); }
        // Успіх: покажемо кнопки і спробуємо надіслати в бот через WebApp bridge
        out.innerHTML = '✅ Створено: <code>'+ (data.invoice?.number || data.id) +'</code>';
        const linkHtml = (window.API_BASE||'') + '/api/invoices/'+data.id+'/html';
        const linkPdf  = (window.API_BASE||'') + '/api/invoices/'+data.id+'/pdf?dl=1';
        document.getElementById('links').innerHTML =
          '<a href="'+linkHtml+'" target="_blank">Відкрити HTML</a> · '+
          '<a href="'+linkPdf+'" target="_blank">Завантажити PDF</a>';

        // Telegram WebApp sendData (щоб бот знав, що інвойс створено)
        try {
          const tg = window.Telegram && window.Telegram.WebApp;
          if (tg && tg.sendData) {
            tg.sendData(JSON.stringify({
              type:'invoice_created',
              id: data.id,
              number: data.invoice?.number || data.id,
              html_url: linkHtml,
              pdf_url:  linkPdf
            }));
          }
        } catch {}
      }catch(e){
        out.innerHTML = '<span class="danger">✖ ' + (e.message || e) + '</span>';
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      pingAPI();
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg && tg.ready) {
        try { tg.expand && tg.expand(); tg.ready(); } catch {}
      }
    });
  </script>
</head>
<body>
  <div class="card">
    <h1>Створити рахунок</h1>

    <div class="muted">
      API: <a id="apiUrl" href="#" target="_blank"></a> · <span id="apiStatus">...</span>
    </div>

    <div class="toolbar">
      <button class="btn secondary" onclick="pingAPI()">Перевірити API</button>
    </div>

    <div class="row">
      <div>
        <label>Назва продавця</label>
        <input id="s_name" placeholder="ТОВ Ромашка" />
      </div>
      <div>
        <label>Назва покупця</label>
        <input id="b_name" placeholder="ФОП Іваненко" />
      </div>
    </div>

    <div class="row">
      <div><label>Адреса продавця</label><input id="s_addr" placeholder="Київ" /></div>
      <div><label>Адреса покупця</label><input id="b_addr" placeholder="Львів" /></div>
    </div>

    <div class="row">
      <div><label>IBAN продавця</label><input id="s_iban" placeholder="UA..." /></div>
      <div><label>ЄДРПОУ/ІПН продавця</label><input id="s_tax" placeholder="1234567890" /></div>
    </div>

    <div class="row">
      <div><label>Email продавця</label><input id="s_email" placeholder="test@example.com" /></div>
      <div><label>Телефон продавця</label><input id="s_phone" placeholder="+380..." /></div>
    </div>

    <div class="row">
      <div>
        <label>Валюта</label>
        <select id="currency">
          <option>UAH</option>
          <option>USD</option>
          <option>EUR</option>
        </select>
      </div>
      <div>
        <label>Нотатки</label>
        <input id="notes" placeholder="Без ПДВ / підпис/печатка" />
      </div>
    </div>

    <table class="items">
      <thead><tr><th>Найменування</th><th>К-сть</th><th>Од.</th><th>Ціна</th></tr></thead>
      <tbody>
        <tr>
          <td><input id="it1_name" placeholder="Послуга/Товар" value="Послуга/Товар"></td>
          <td><input id="it1_qty"  placeholder="1" value="1"></td>
          <td><input id="it1_unit" placeholder="шт" value="шт"></td>
          <td><input id="amount"    placeholder="1234,56" value="1000,00"></td>
        </tr>
      </tbody>
    </table>

    <div class="row" style="margin-top:12px">
      <div><label>Опис для рахунку</label><input id="desc" placeholder="Розробка / Консультації" /></div>
    </div>

    <div class="toolbar">
      <button class="btn" onclick="submitForm()">Створити рахунок</button>
      <button class="btn secondary" onclick="document.querySelector('form')?.reset?.()">Очистити</button>
    </div>

    <div id="out" class="footer"></div>
    <div id="links" class="footer"></div>
  </div>
</body>
</html>
