<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>InvOUA WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 18px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input, textarea { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .btn { display:inline-block; padding:8px 12px; margin-top:12px; border:1px solid #ccc; border-radius:6px; cursor:pointer; background:#f6f6f6; }
    .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    .muted { color:#666; font-size:13px; }
    pre { background:#111; color:#9ef; padding:10px; border-radius:6px; max-height:220px; overflow:auto;}
  </style>
</head>
<body>
  <h2>InvOUA – демо</h2>
  <div id="status" class="muted"></div>

  <div class="row">
    <div>
      <h3>Продавець</h3>
      <label>Назва <input id="s_name" placeholder="ТОВ Приклад"></label>
      <label>Адреса <input id="s_addr" placeholder="м. Київ, вул…"></label>
      <label>Email <input id="s_email" placeholder="seller@example.com"></label>
      <label>Телефон <input id="s_phone" placeholder="+380…"></label>
      <label>IBAN <input id="s_iban" placeholder="UA…"></label>
      <label>ЄДРПОУ/ІПН <input id="s_tax" placeholder="12345678"></label>
      <label>Лого URL <input id="s_logo" placeholder="https://...png"></label>
      <label>Печатка URL <input id="s_stamp" placeholder="https://...png"></label>
      <label>Підпис URL <input id="s_sign" placeholder="https://...png"></label>
      <button class="btn" id="saveSeller">Зберегти продавця</button>
      <div class="muted">Використовуватиметься в рахунку</div>
    </div>
    <div>
      <h3>Покупець</h3>
      <label>Назва <input id="b_name" placeholder="ФОП Іванов"></label>
      <label>Адреса <input id="b_addr" placeholder="м. Львів, вул…"></label>
      <label>Email <input id="b_email" placeholder="buyer@example.com"></label>
      <label>Телефон <input id="b_phone" placeholder="+380…"></label>

      <h3 style="margin-top:20px">Позиції</h3>
      <label>Найменування <input id="it_name" value="Послуги"></label>
      <label>К-сть <input id="it_qty" type="number" step="1" value="1"></label>
      <label>Од. <input id="it_unit" value="шт"></label>
      <label>Ціна <input id="it_price" type="number" step="0.01" value="1700"></label>

      <h3 style="margin-top:20px">Рахунок</h3>
      <label>Номер <input id="inv_no" placeholder="(auto)"></label>
      <label>Валюта <input id="inv_cur" value="UAH"></label>
      <label>Нотатка <textarea id="inv_notes" rows="2"></textarea></label>

      <button class="btn primary" id="makeInvoice">Створити рахунок</button>
      <div id="afterCreate" style="display:none; margin-top:10px">
        <button class="btn" id="openPdf">Відкрити PDF</button>
        <button class="btn" id="downloadPdf">Завантажити PDF</button>
        <button class="btn" id="openHtml">Переглянути HTML</button>
      </div>
    </div>
  </div>

  <h3 style="margin-top:24px">Журнал</h3>
  <pre id="log"></pre>

<script>
// ================== UTIL & INIT ==================
const QS = new URLSearchParams(location.search);
const API = (QS.get('api') || '').replace(/\/+$/,'');
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
function log(...args){ const s=args.map(x=>typeof x=='string'?x:JSON.stringify(x,null,2)).join(' '); logEl.textContent += s + '\n'; }

if(!API){
  statusEl.textContent = 'Помилка: у URL має бути ?api=... (адреса вашого API/ngrok).';
} else {
  statusEl.textContent = 'API = ' + API;
}

// single wipe block (кеш, IndexedDB, WebStorage) + версія
(async function wipeIfAsked(){
  if (!QS.has('wipe') && !QS.has('wipe_fonts')) return;
  try {
    if (window.caches?.keys) {
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n).catch(()=>{})));
    }
    if (indexedDB?.databases) {
      const dbs = await indexedDB.databases();
      await Promise.all((dbs || []).map(d => new Promise(res => {
        const req = indexedDB.deleteDatabase(d.name);
        req.onsuccess = req.onerror = req.onblocked = () => res();
      })));
    }
    try { localStorage.clear(); } catch(_){}
    try { sessionStorage.clear(); } catch(_){}
  } catch(e) { console.warn('Wipe error:', e); }
  QS.delete('wipe'); QS.delete('wipe_fonts');
  if (!QS.has('v')) QS.set('v', Date.now().toString());
  location.replace(location.pathname + '?' + QS.toString());
})();

// ngrok bypass helper
function urlWithBypass(pathOrUrl){
  const u = new URL(pathOrUrl, API + '/');
  if (u.host.includes('ngrok-free.app') && !u.searchParams.has('ngrok-skip-browser-warning')) {
    u.searchParams.set('ngrok-skip-browser-warning','1');
  }
  return u.toString();
}

// fetch with timeout + bypass header
const FETCH_TIMEOUT_MS = 15000;
async function apiFetch(path, options={}){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort('timeout'), FETCH_TIMEOUT_MS);
  try{
    const headers = Object.assign({
      'Content-Type':'application/json',
      'ngrok-skip-browser-warning':'1',
      'Cache-Control':'no-store'
    }, options.headers||{});
    const res = await fetch(urlWithBypass(path.startsWith('http') ? path : API + path), {
      ...options, headers, signal: controller.signal
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      throw new Error(`HTTP ${res.status}: ${txt}`);
    }
    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : res.text();
  } finally { clearTimeout(t); }
}

// optional prewarm
(async ()=>{
  if(!API) return;
  try{
    const t0 = performance.now();
    const r = await apiFetch('/api/health', { method:'GET' });
    log('health:', r, `(${Math.round(performance.now()-t0)}ms)`);
  }catch(e){ log('health error:', e.message); }
})();

// ================== HANDLERS ==================
document.getElementById('saveSeller').onclick = async () => {
  try{
    const seller = {
      name: s_name.value, address: s_addr.value, email: s_email.value, phone: s_phone.value,
      iban: s_iban.value, tax_id: s_tax.value, logo_url: s_logo.value, stamp_url: s_stamp.value, sign_url: s_sign.value
    };
    const r = await apiFetch('/api/seller', { method:'PUT', body: JSON.stringify(seller) });
    log('seller saved:', r);
    alert('Збережено продавця');
  }catch(e){
    log('seller save error:', e.message);
    alert('Помилка збереження продавця: ' + e.message);
  }
};

let lastInvoiceId = null;
document.getElementById('makeInvoice').onclick = async () => {
  try{
    const payload = {
      seller: {
        name: s_name.value, address: s_addr.value, email: s_email.value, phone: s_phone.value,
        iban: s_iban.value, tax_id: s_tax.value, logo_url: s_logo.value, stamp_url: s_stamp.value, sign_url: s_sign.value
      },
      buyer: { name: b_name.value, address: b_addr.value, email: b_email.value, phone: b_phone.value },
      items: [{ name: it_name.value, qty: Number(it_qty.value||1), unit: it_unit.value||'шт', price: Number(it_price.value||0) }],
      invoice: { number: inv_no.value || '', currency: inv_cur.value||'UAH', notes: inv_notes.value||'' }
    };
    const r = await apiFetch('/api/invoices', { method:'POST', body: JSON.stringify(payload) });
    log('invoice created:', r);
    lastInvoiceId = r.id;
    document.getElementById('afterCreate').style.display = 'block';
  }catch(e){
    log('invoice create error:', e.message);
    alert('Помилка створення рахунку: ' + e.message);
  }
};

// PDF open as BLOB (ngrok-landing bypass) + Safari-safe open
async function openPdfBlob(invId, download=false){
  const pdfUrl = urlWithBypass(API + `/api/invoices/${encodeURIComponent(invId)}/pdf`);
  // попередньо відкриємо вікно (для Safari/Telegram WebView), щоб не заблокувало
  const win = window.open('about:blank', '_blank', 'noopener');
  try{
    const res = await fetch(pdfUrl, { headers: { 'ngrok-skip-browser-warning':'1' }});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const blob = await res.blob();
    const blobUrl = URL.createObjectURL(blob);
    if(download){
      const a = document.createElement('a'); a.href = blobUrl; a.download = `${invId}.pdf`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(blobUrl), 2000);
      if (win) win.close();
    }else{
      if (win) win.location.href = blobUrl; else window.open(blobUrl, '_blank');
      setTimeout(()=>URL.revokeObjectURL(blobUrl), 60000);
    }
  }catch(e){
    log('pdf open error:', e.message);
    if (win) win.location.href = pdfUrl; else window.open(pdfUrl, '_blank');
  }
}

document.getElementById('openPdf').onclick = () => {
  if(!lastInvoiceId) return alert('Спершу створіть рахунок.');
  openPdfBlob(lastInvoiceId,false);
};

document.getElementById('downloadPdf').onclick = () => {
  if(!lastInvoiceId) return alert('Спершу створіть рахунок.');
  openPdfBlob(lastInvoiceId,true);
};

document.getElementById('openHtml').onclick = () => {
  if(!lastInvoiceId) return alert('Спершу створіть рахунок.');
  const u = urlWithBypass(API + `/api/invoices/${encodeURIComponent(lastInvoiceId)}/html`);
  window.open(u, '_blank', 'noopener');
};
</script>
</body>
</html>
