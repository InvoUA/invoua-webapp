<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>InvoUA — створення рахунку</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--txt:#e8eefc;--muted:#8ea1c7;--acc:#4ea1ff;--ok:#33d18f;--bad:#ff5562;border-color:#263453}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:920px;margin:32px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
    h1{margin:0 0 12px 0;font-weight:700}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1.5fr .5fr .5fr .7fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);background:#0e1626;color:var(--txt);border-radius:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--acc)}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{background:var(--acc);border:0;color:#00142c;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:#233149;color:var(--txt)}
    .badge{display:inline-flex;gap:8px;align-items:center;font-size:12px;padding:6px 10px;border-radius:999px;background:#0f1930;border:1px solid var(--border)}
    .ok{color:var(--ok);border-color:rgba(51,209,143,.35)}
    .bad{color:var(--bad);border-color:rgba(255,85,98,.35)}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .k{width:80px;text-align:center}
    .u{width:80px}
    .p{width:140px;text-align:right}
    @media (max-width:720px){.row,.row-3{grid-template-columns:1fr}}
  </style>
  <!-- (опційно) локальні значення баз приходять звідси -->
  <script src="./webapp_env.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Створення рахунку</h1>
      <div id="envLine" class="muted" style="margin-bottom:10px"></div>

      <div class="grid" style="margin-top:8px">
        <div class="field"><label>Назва рахунку/нотатка (опц.)</label><input id="note" placeholder="Напр.: Договір №12"></div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div class="muted">Продавець</div>
        <div class="row">
          <div class="field"><label>Назва</label><input id="s_name" placeholder="ФОП Іваненко Іван"></div>
          <div class="field"><label>Місто/адреса</label><input id="s_addr" placeholder="Київ"></div>
        </div>
        <div class="row">
          <div class="field"><label>IBAN</label><input id="s_iban" placeholder="UA..."></div>
          <div class="field"><label>ЄДРПОУ/ІПН</label><input id="s_tax" placeholder="1234567890"></div>
        </div>
        <div class="row">
          <div class="field"><label>Email</label><input id="s_email" placeholder="seller@example.com"></div>
          <div class="field"><label>Телефон</label><input id="s_phone" placeholder="+380..."></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div class="muted">Покупець</div>
        <div class="row">
          <div class="field"><label>Назва</label><input id="b_name" placeholder="ТОВ «Ромашка»"></div>
          <div class="field"><label>Адреса</label><input id="b_addr" placeholder="Львів"></div>
        </div>
        <div class="row">
          <div class="field"><label>ЄДРПОУ/ІПН</label><input id="b_tax" placeholder="12345678"></div>
          <div class="field"><label>Email/Телефон</label><input id="b_email" placeholder="acct@client.com / +380..."></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div class="muted">Позиції</div>

        <div id="items"></div>
        <div class="actions">
          <button class="secondary" id="addItem">+ Додати позицію</button>
          <span class="badge" id="fmtHint">Формат ціни: 1234,56</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="field"><label>Валюта</label>
          <select id="cur">
            <option value="UAH" selected>UAH</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div class="field"><label>Місце виписки</label><input id="place" placeholder="Київ"></div>
      </div>
      <div class="row">
        <div class="field" style="grid-column:1/-1"><label>Коментар (примітки)</label><input id="notes" placeholder="Без ПДВ / Договір №..."></div>
      </div>

      <div class="actions">
        <button id="make">Створити рахунок</button>
        <button id="openHtml" class="secondary" style="display:none">Відкрити HTML</button>
        <button id="getPdf" class="secondary" style="display:none">Завантажити PDF</button>
        <span id="status" class="badge"></span>
      </div>
    </div>
  </div>

<script>
(function () {
  // ---------- 1) Збір баз (API_BASE / APP_BASE) ----------
  function take(param) {
    const url = new URL(location.href);
    const fromSearch = url.searchParams.get(param);
    if (fromSearch) return fromSearch;
    if (url.hash && url.hash.includes('=')) {
      const h = new URLSearchParams(url.hash.slice(1));
      if (h.get(param)) return h.get(param);
    }
    return null;
  }

  // із webapp_env.js (якщо існує)
  let API_BASE = (window.API_BASE || '').trim();
  let APP_BASE = (window.APP_BASE || '').trim();

  // із URL
  API_BASE = take('api') || API_BASE;
  APP_BASE = take('app') || APP_BASE;

  // дефолти для локалки
  if (!API_BASE) API_BASE = (location.hostname === '127.0.0.1' || location.hostname === 'localhost')
      ? 'http://127.0.0.1:8081' : '';
  if (!APP_BASE) APP_BASE = location.origin;

  // показати стани
  const envLine = document.getElementById('envLine');
  function setEnvInfo(okApi, msg) {
    envLine.innerHTML =
      `APP_BASE: <span class="badge">${APP_BASE}</span> · ` +
      `API_BASE: <span class="badge ${okApi?'ok':'bad'}">${API_BASE || '—'}</span>` +
      (msg ? ` · <span class="badge ${okApi?'ok':'bad'}">${msg}</span>` : '');
  }

  // ---------- 2) Перевірка доступності API ----------
  async function ping() {
    if (!API_BASE) { setEnvInfo(false, 'Немає доступу до API'); return false; }
    try {
      const res = await fetch(`${API_BASE}/health`, {
        headers: {'ngrok-skip-browser-warning':'true'}
      });
      if (!res.ok) throw new Error(res.status);
      setEnvInfo(true, 'OK');
      return true;
    } catch (e) {
      setEnvInfo(false, 'Немає доступу до API');
      return false;
    }
  }

  // ---------- 3) UI: позиції ----------
  const itemsRoot = document.getElementById('items');
  function line(name='', qty='1', unit='шт', price='1000,00') {
    const row = document.createElement('div');
    row.className = 'row-3';
    row.innerHTML = `
      <div class="field"><label>Найменування</label><input placeholder="Послуга/Товар" value="${name}"></div>
      <div class="field k"><label>К-сть</label><input value="${qty}"></div>
      <div class="field u"><label>Од.</label><input value="${unit}"></div>
      <div class="field p"><label>Ціна</label><input value="${price}"></div>
    `;
    return row;
  }
  itemsRoot.appendChild(line());
  document.getElementById('addItem').onclick = () => itemsRoot.appendChild(line(''));

  // ---------- 4) Telegram bridge (якщо є) ----------
  const tg = window.Telegram && window.Telegram.WebApp;
  if (tg && tg.setHeaderColor) tg.setHeaderColor('#0b1220');

  function sendToBot(payload) {
    try { tg && tg.sendData && tg.sendData(JSON.stringify(payload)); } catch(e){}
  }

  // ---------- 5) Створення інвойсу ----------
  const btnMake = document.getElementById('make');
  const btnHtml = document.getElementById('openHtml');
  const btnPdf  = document.getElementById('getPdf');
  const statusB = document.getElementById('status');

  function fmt(s){ return (s||'').trim(); }

  btnMake.onclick = async () => {
    statusB.textContent = 'Створюю…';
    statusB.className = 'badge';

    if (!await ping()) { return; }

    // зібрати дані
    const its = [...itemsRoot.querySelectorAll('.row-3')].map(r=>{
      const [n,q,u,p] = r.querySelectorAll('input');
      return { name: fmt(n.value), qty: fmt(q.value||'1'), unit: fmt(u.value||'шт'), price: fmt(p.value||'0,00') };
    }).filter(x=>x.name);

    const payload = {
      seller: {
        name: fmt(document.getElementById('s_name').value),
        address: fmt(document.getElementById('s_addr').value),
        iban: fmt(document.getElementById('s_iban').value),
        tax_id: fmt(document.getElementById('s_tax').value),
        email: fmt(document.getElementById('s_email').value),
        phone: fmt(document.getElementById('s_phone').value)
      },
      buyer: {
        name: fmt(document.getElementById('b_name').value),
        address: fmt(document.getElementById('b_addr').value),
        tax_id: fmt(document.getElementById('b_tax').value),
        email: fmt(document.getElementById('b_email').value)
      },
      items: its,
      invoice: {
        currency: fmt(document.getElementById('cur').value||'UAH'),
        notes: fmt(document.getElementById('notes').value||document.getElementById('note').value||''),
        place_city: fmt(document.getElementById('place').value||'')
      }
    };

    try{
      const res = await fetch(`${API_BASE}/api/invoices`, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'ngrok-skip-browser-warning':'true'
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();

      const id = data.id || data.invoice_id || '';
      const htmlUrl = `${API_BASE}/api/invoices/${id}/html`;
      const pdfUrl  = `${API_BASE}/api/invoices/${id}/pdf?dl=1`;

      btnHtml.style.display = 'inline-block';
      btnPdf.style.display  = 'inline-block';
      btnHtml.onclick = ()=> window.open(htmlUrl,'_blank','noopener');

      // Завантаження PDF без «вітальної» сторінки ngrok
      btnPdf.onclick = async ()=>{
        try{
          const r = await fetch(pdfUrl, { headers:{'ngrok-skip-browser-warning':'true'} });
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = (data.number || id || 'invoice') + '.pdf';
          document.body.appendChild(a); a.click();
          setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 500);
        }catch(e){
          window.open(pdfUrl,'_blank','noopener');
        }
      };

      statusB.textContent = `Готово: ${data.number || id}`;
      statusB.className = 'badge ok';

      // у Telegram — відправимо метадані в бот
      sendToBot({type:'invoice_created', id, number:data.number, html_url: htmlUrl, pdf_url: pdfUrl});
    }catch(e){
      statusB.textContent = 'Помилка створення';
      statusB.className = 'badge bad';
      console.error(e);
    }
  };

  // перша перевірка
  ping();
})();
</script>
</body>
</html>
