<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>InvoUA — створення рахунку</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --muted:#666; --accent:#2563eb; }
    html,body{margin:0;padding:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'DejaVu Sans',Arial,sans-serif}
    .wrap{max-width:880px;margin:24px auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px}
    h1{margin:0 0 12px 0;font-size:20px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;margin-bottom:10px}
    .field label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .field input,.field textarea,.field select{
      font-size:14px;padding:10px;border:1px solid #ddd;border-radius:10px;outline:none
    }
    .muted{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .primary{background:var(--accent);color:#fff}
    .ghost{background:#eef2ff}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left}
    th{background:#f3f4f6}
    .right{text-align:right}
    .status{margin:8px 0 0 0;font-size:12px}
    .ok{color:#16a34a}.warn{color:#b45309}.bad{color:#dc2626}
  </style>
  <script>
    (function bootEnv(){
      // 1) Джерело баз із URL (бот передає ?api=&app=)
      const qs=new URLSearchParams(location.search);
      const apiFromUrl = qs.get('api');
      const appFromUrl = qs.get('app');
      // 2) Фолбек: локально (для ноутбука)
      const apiDefault = "http://127.0.0.1:8081";
      const appDefault = location.origin;
      // 3) Фінально
      window.API_BASE = apiFromUrl || window.API_BASE || apiDefault;
      window.APP_BASE = appFromUrl || window.APP_BASE || appDefault;

      // Маленький пінг-індикатор
      window.addEventListener('DOMContentLoaded', async () => {
        const el = document.getElementById('ping');
        try{
          const r = await fetch(window.API_BASE.replace(/\/$/,'')+'/health', {
            headers:{'ngrok-skip-browser-warning':'1'}
          });
          if(!r.ok) throw new Error('bad');
          const j=await r.json().catch(()=>({}));
          el.textContent='API OK';
          el.className='status ok';
        }catch(e){
          el.textContent='API недоступний';
          el.className='status bad';
        }
      });

      // 4) Обгортка fetch: всюди ставимо ngrok-байпас
      const origFetch = window.fetch;
      window.fetch = async function(input, init={}){
        init.headers = init.headers||{};
        if(typeof init.headers==='object'){
          init.headers['ngrok-skip-browser-warning']='1';
        }
        return origFetch(input, init);
      };
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Створити рахунок</h1>
      <div class="muted">API: <code id="apiBase"></code> • <span id="ping" class="status warn">перевіряю…</span></div>
      <script>document.getElementById('apiBase').textContent = (window.API_BASE||'') + '/api/invoices';</script>

      <div class="row" style="margin-top:14px">
        <div class="field">
          <label>Продавець — Назва</label>
          <input id="seller_name" placeholder="ФОП Приклад" />
        </div>
        <div class="field">
          <label>Покупець — Назва</label>
          <input id="buyer_name" placeholder="ТОВ Ромашка" />
        </div>
        <div class="field">
          <label>Адреса продавця</label>
          <input id="seller_addr" placeholder="Київ" />
        </div>
        <div class="field">
          <label>Адреса покупця</label>
          <input id="buyer_addr" placeholder="Львів" />
        </div>
        <div class="field">
          <label>IBAN продавця</label>
          <input id="seller_iban" placeholder="UA..." />
        </div>
        <div class="field">
          <label>ЄДРПОУ/ІПН продавця</label>
          <input id="seller_tax" placeholder="1234567890" />
        </div>
        <div class="field">
          <label>Email продавця</label>
          <input id="seller_email" placeholder="test@example.com" />
        </div>
        <div class="field">
          <label>Телефон продавця</label>
          <input id="seller_phone" placeholder="+380..." />
        </div>
        <div class="field">
          <label>Валюта</label>
          <select id="currency">
            <option value="UAH">UAH</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div class="field">
          <label>Нотатки (необов’язково)</label>
          <input id="notes" placeholder="Без ПДВ / підпис/печатка необов’язкові" />
        </div>
      </div>

      <div style="margin-top:8px">
        <table id="items">
          <thead><tr>
            <th style="width:48%">Найменування</th>
            <th style="width:10%">К-сть</th>
            <th style="width:12%">Од.</th>
            <th style="width:15%">Ціна</th>
            <th style="width:15%">Сума</th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <div class="actions">
          <button class="ghost" onclick="addRow()">+ Додати позицію</button>
          <span class="muted">Використовуйте кому для копійок: 1234,56</span>
        </div>
      </div>

      <div class="actions">
        <button class="primary" onclick="createInvoice()">Створити рахунок</button>
        <button onclick="quickFill()" class="ghost">Швидко заповнити приклад</button>
      </div>

      <div id="result" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    // Telegram WebApp об’єкт (якщо сторінка відкрита в боті)
    const TG = window.Telegram && window.Telegram.WebApp;

    function addRow(data){
      const tb = document.querySelector('#items tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input placeholder="Опис" value="${(data&&data.name)||''}"></td>
        <td><input style="width:80px" value="${(data&&data.qty)||'1'}"></td>
        <td><input style="width:80px" value="${(data&&data.unit)||'шт'}"></td>
        <td><input style="width:120px" value="${(data&&data.price)||'100,00'}"></td>
        <td class="right muted">—</td>
      `;
      tb.appendChild(tr);
      recalc();
      tr.querySelectorAll('input').forEach(i => i.addEventListener('input', recalc));
    }

    function recalc(){
      const rows=[...document.querySelectorAll('#items tbody tr')];
      rows.forEach(tr=>{
        const [name,qty,unit,price] = [...tr.querySelectorAll('input')].map(i=>i.value.trim());
        const nqty = parseFloat((qty||'1').replace(',','.'))||0;
        const nprice = parseFloat((price||'0').replace(',','.'))||0;
        const sum = nqty*nprice;
        tr.querySelector('td.right').textContent = (isNaN(sum)?'—':sum.toFixed(2).replace('.',',')); 
      });
    }

    function quickFill(){
      document.getElementById('seller_name').value='ФОП Іваненко Іван';
      document.getElementById('seller_addr').value='Київ';
      document.getElementById('seller_iban').value='UA123...';
      document.getElementById('seller_tax').value='1234567890';
      document.getElementById('seller_email').value='test@example.com';
      document.getElementById('seller_phone').value='+380...';
      document.getElementById('buyer_name').value='ТОВ Ромашка';
      document.getElementById('buyer_addr').value='Львів';
      document.getElementById('currency').value='UAH';
      document.getElementById('notes').value='Без ПДВ';
      document.querySelector('#items tbody').innerHTML='';
      addRow({name:'Послуги обліку', qty:'1', unit:'шт', price:'1000,00'});
      addRow({name:'Консультація', qty:'2', unit:'год', price:'250,00'});
    }

    async function createInvoice(){
      const API = (window.API_BASE||'').replace(/\/$/,'');
      const result = document.getElementById('result');
      result.textContent='Створюю…';

      const seller = {
        name:  document.getElementById('seller_name').value.trim(),
        address:document.getElementById('seller_addr').value.trim(),
        iban:  document.getElementById('seller_iban').value.trim(),
        tax_id:document.getElementById('seller_tax').value.trim(),
        email: document.getElementById('seller_email').value.trim(),
        phone: document.getElementById('seller_phone').value.trim()
      };
      const buyer = {
        name:  document.getElementById('buyer_name').value.trim(),
        address:document.getElementById('buyer_addr').value.trim()
      };
      const items = [...document.querySelectorAll('#items tbody tr')].map(tr=>{
        const [name,qty,unit,price] = [...tr.querySelectorAll('input')].map(i=>i.value.trim());
        return {name, qty, unit, price};
      });
      const invoice = {
        currency: document.getElementById('currency').value,
        notes: document.getElementById('notes').value.trim()
      };

      try{
        const resp = await fetch(API+'/api/invoices',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({seller,buyer,items,invoice})
        });
        if(!resp.ok){
          const t = await resp.text();
          throw new Error('Помилка створення: '+t);
        }
        const data = await resp.json(); // {id, links: {html, pdf}}
        result.innerHTML = `✅ Рахунок створено: <a href="${data.links.html}" target="_blank">HTML</a>`;

        // 1) Завантажити PDF як файл (без відкриття вкладки, без "віталки")
        await downloadPdf(API + data.links.pdf);

        // 2) Якщо це Telegram WebApp — відправити дані назад у бота
        try{
          if (TG && TG.sendData) {
            TG.sendData(JSON.stringify({
              type:'invoice_created',
              id:data.id,
              html_url: data.links.html,
              pdf_url: data.links.pdf
            }));
          }
        }catch(e){}

      }catch(err){
        result.textContent = '❌ '+(err.message||err);
      }
    }

    async function downloadPdf(url){
      const a = document.createElement('a');
      const r = await fetch(url, {headers:{}, cache:'no-store'});
      if(!r.ok) throw new Error('Не вдалося завантажити PDF');
      const blob = await r.blob();
      const fileUrl = URL.createObjectURL(blob);
      a.href = fileUrl;
      a.download = 'invoice.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(fileUrl);
    }

    // Додай перший рядок за замовчуванням
    document.addEventListener('DOMContentLoaded', ()=> addRow());
  </script>
</body>
</html>
