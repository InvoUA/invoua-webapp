<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>InvoUA ‚Äî —Ä–∞—Ö—É–Ω–æ–∫ –∑–∞ 60 —Å–µ–∫—É–Ω–¥ (v2, Cyrillic PDF)</title>
  <style>
    :root { --gap: 10px; }
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 0; padding: 14px; }
    h1 { font-size: 20px; margin: 0 0 12px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    label { font-size:12px; color:#444; }
    input, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#f8f8f8; text-align:left; }
    .btns { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:10px 14px; border:0; border-radius:999px; background:#0a84ff; color:#fff; font-weight:600; }
    button.secondary { background:#eee; color:#222; }
    .muted { color:#666; font-size:12px; }
    .toast { margin-top:10px; font-size:13px; }
    .ok { color: #0a7d2f; }
    .err { color: #b00020; }
    .hidden { display:none; }
  </style>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <h1>InvoUA ‚Äî —Ä–∞—Ö—É–Ω–æ–∫ –∑–∞ 60 —Å–µ–∫—É–Ω–¥ <span style="color:#888;font-size:12px">/ v2</span></h1>

  <div class="grid">
    <div>
      <label>–ü–æ–∫—É–ø–µ—Ü—å (–Ω–∞–∑–≤–∞/–ü–Ü–ë)</label>
      <input id="buyer_name" placeholder="–¢–û–í –ü—Ä–∏–∫–ª–∞–¥">
    </div>
    <div>
      <label>–í–∞–ª—é—Ç–∞</label>
      <select id="currency">
        <option>UAH</option><option>USD</option><option>EUR</option>
      </select>
    </div>
  </div>

  <table id="items">
    <thead>
      <tr>
        <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th><th style="width:80px">–ö-—Å—Ç—å</th><th style="width:80px">–û–¥.</th><th style="width:120px">–¶—ñ–Ω–∞</th><th style="width:40px"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="btns">
    <button id="add">+ –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
    <button id="save">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫</button>
  </div>

  <div id="result" class="hidden">
    <div class="btns">
      <button id="btnPdf">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</button>
      <button id="btnHtml" class="secondary">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è (HTML)</button>
      <button id="btnNew" class="secondary">–ù–æ–≤–∏–π</button>
    </div>
    <div id="toast" class="toast ok"></div>
  </div>

  <p class="muted">–¶—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –ø—Ä–∞—Ü—é—î —è–∫ Telegram Mini App. API-–∞–¥—Ä–µ—Å–∞ –±–µ—Ä–µ—Ç—å—Å—è –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ <code>?api=</code>.</p>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) try { tg.expand(); } catch(e) {}

  const $ = s => document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const API = qs.get('api')?.replace(/\/$/,'') || '';

  const tbody = $('#items tbody');
  function addRow(name='', qty='1', unit='se', price='0'){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name" placeholder="–ü–æ—Å–ª—É–≥–∞" value="${name}"></td>
      <td><input class="qty" type="number" step="0.01" value="${qty}"></td>
      <td><input class="unit" value="${unit}"></td>
      <td><input class="price" type="number" step="0.01" value="${price}"></td>
      <td><button class="secondary del">x</button></td>`;
    tr.querySelector('.del').onclick = () => tr.remove();
    tbody.appendChild(tr);
  }
  $('#add').onclick = () => addRow();
  addRow('–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ–π–Ω—ñ –ø–æ—Å–ª—É–≥–∏', '1', 'se', '1200');
  addRow('–†–µ–∫–ª–∞–º–∞', '1', 'se', '500');

  function collectItems(){
    return [...tbody.querySelectorAll('tr')].map(tr => ({
      name: tr.querySelector('.name').value.trim(),
      qty: tr.querySelector('.qty').value || '1',
      unit: tr.querySelector('.unit').value || 'se',
      price: tr.querySelector('.price').value || '0'
    })).filter(it => it.name);
  }

  async function saveInvoice(){
    if(!API){ alert('–ù–µ –∑–∞–¥–∞–Ω–æ ?api= —É URL'); return; }
    const payload = {
      invoice: { currency: $('#currency').value },
      buyer:   { name: $('#buyer_name').value.trim() },
      items:   collectItems()
    };
    const r = await fetch(API + '/api/invoices', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error('API error ' + r.status); }
    return await r.json();
  }

  async function getInvoiceJson(id){
    const r = await fetch(`${API}/api/invoices/${id}`, {
      headers: { 'ngrok-skip-browser-warning': '1' }
    });
    if(!r.ok) throw new Error('GET JSON ' + r.status);
    return await r.json();
  }

  function money(x){ return (Number(x)||0).toFixed(2); }

  function ab2b64(buf){
    let binary = ''; const bytes = new Uint8Array(buf);
    const chunk = 0x8000;
    for (let i=0; i<bytes.length; i+=chunk){
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
    }
    return btoa(binary);
  }

  async function loadFontsInto(pdf){
    // —à–ª—è—Ö–∏ –¥–æ —à—Ä–∏—Ñ—Ç—ñ–≤ —É —Ü—å–æ–º—É –∂ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó
    // –Ω–∞–ø—Ä.: https://invoua.github.io/invoua-webapp/fonts/DejaVuSans.ttf
    const base = location.origin + location.pathname.replace(/\/[^\/]*$/, '') + '/fonts';
    const files = [
      {file:'DejaVuSans.ttf', name:'DejaVu', style:'normal'},
      {file:'DejaVuSans-Bold.ttf', name:'DejaVu', style:'bold'}
    ];
    for (const f of files){
      const res = await fetch(`${base}/${f.file}`, {cache:'reload'});
      if (!res.ok) throw new Error(`Font ${f.file} ${res.status}`);
      const buf = await res.arrayBuffer();
      pdf.addFileToVFS(f.file, ab2b64(buf));
      pdf.addFont(f.file, f.name, f.style);
    }
    pdf.setFont('DejaVu','normal');
  }

  function renderPdfFromJson(doc){
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF) throw new Error('jsPDF –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è');
    const pdf = new jsPDF('p','mm','a4');
    const M = 12, W = pdf.internal.pageSize.getWidth() - M*2;

    const cur = doc.invoice.currency || 'UAH';
    const s = doc.seller || {}, b = doc.buyer || {};
    let y = 18;

    pdf.setFont('DejaVu','bold'); pdf.setFontSize(16);
    pdf.text(`–†–∞—Ö—É–Ω–æ–∫ ${doc.invoice.number || ''}`, M, y); y += 6;

    pdf.setFont('DejaVu','normal'); pdf.setFontSize(10);
    pdf.text(`–î–∞—Ç–∞: ${doc.invoice.issue_date || ''}`, M, y);
    if (doc.invoice.due_date) pdf.text(`–û–ø–ª–∞—Ç–∏—Ç–∏ –¥–æ: ${doc.invoice.due_date}`, M+60, y);
    y += 10;

    pdf.setFont('DejaVu','bold'); pdf.text('–ü—Ä–æ–¥–∞–≤–µ—Ü—å', M, y);
    pdf.setFont('DejaVu','normal');
    const sellerLines = [s.name, s.tax_id && `–Ñ–î–†–ü–û–£/–Ü–ü–ù: ${s.tax_id}`, s.iban && `IBAN: ${s.iban}`, s.address].filter(Boolean);
    sellerLines.forEach((t,i)=> pdf.text(String(t), M, y+6+i*5));

    pdf.setFont('DejaVu','bold'); pdf.text('–ü–æ–∫—É–ø–µ—Ü—å', M+W/2, y);
    pdf.setFont('DejaVu','normal');
    const buyerLines = [b.name, b.tax_id && `–Ñ–î–†–ü–û–£/–Ü–ü–ù: ${b.tax_id}`, b.iban && `IBAN: ${b.iban}`, b.address].filter(Boolean);
    buyerLines.forEach((t,i)=> pdf.text(String(t), M+W/2, y+6+i*5));

    y += 6 + Math.max(sellerLines.length, buyerLines.length)*5 + 8;

    // –¢–∞–±–ª–∏—Ü—è –ø–æ–∑–∏—Ü—ñ–π
    const cols = [
      { key:'name',  title:'–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è', w:86 },
      { key:'qty',   title:'–ö-—Å—Ç—å',         w:20 },
      { key:'unit',  title:'–û–¥.',           w:20 },
      { key:'price', title:'–¶—ñ–Ω–∞',          w:30 },
      { key:'line_total', title:'–°—É–º–∞',     w:30 },
    ];
    pdf.setFont('DejaVu','bold');
    let x = M; cols.forEach(c=>{ pdf.text(c.title, x+1, y); x += c.w; });
    y += 5; pdf.setFont('DejaVu','normal');

    (doc.items||[]).forEach(it=>{
      x = M;
      const row = [
        String(it.name||''),
        String(it.qty||''),
        String(it.unit||''),
        money(it.price||'0'),
        money(it.line_total || (Number(it.qty||1)*Number(it.price||0)))
      ];
      row.forEach((v,i)=>{
        const cw = cols[i].w;
        const lines = pdf.splitTextToSize(v, cw-2);
        lines.forEach((ln,j)=> pdf.text(ln, x+1, y + j*5));
        y += (lines.length-1)*5;
        x += cw;
      });
      y += 6;
      if (y > 280){ pdf.addPage(); y = 20; }
    });

    y += 2;
    pdf.text(`–†–∞–∑–æ–º –±–µ–∑ –ü–î–í: ${money(doc.invoice.subtotal)} ${cur}`, M+W/2, y); y += 6;
    pdf.text(`–ü–î–í: ${money(doc.invoice.tax_total)} ${cur}`, M+W/2, y); y += 6;
    pdf.setFont('DejaVu','bold');
    pdf.text(`–î–æ –æ–ø–ª–∞—Ç–∏: ${money(doc.invoice.total)} ${cur}`, M+W/2, y); y += 8;
    pdf.setFont('DejaVu','normal');

    if (doc.invoice.notes){
      pdf.text('–ü—Ä–∏–º—ñ—Ç–∫–∏:', M, y); y += 5;
      pdf.text(pdf.splitTextToSize(String(doc.invoice.notes), W), M, y);
    }

    const url = pdf.output('bloburl');
    if (window.Telegram?.WebApp?.openLink) {
      window.Telegram.WebApp.openLink(url);
    } else {
      const a = document.createElement('a'); a.href = url; a.download = 'invoice.pdf';
      document.body.appendChild(a); a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }
  }

  // UI
  $('#save').onclick = async () => {
    try{
      const res = await saveInvoice();
      $('#result').classList.remove('hidden');
      $('#toast').classList.remove('err'); $('#toast').classList.add('ok');
      $('#toast').textContent = `–ó–±–µ—Ä–µ–∂–µ–Ω–æ. ‚Ññ ${res.number}. –°—É–º–∞: ${res.total}`;

      $('#btnHtml').onclick = () => {
        const url = res.public_url + (res.public_url.includes('?') ? '&' : '?') + 'ngrok-skip-browser-warning=1';
        (window.Telegram?.WebApp?.openLink ? window.Telegram.WebApp.openLink(url) : window.open(url, '_blank'));
      };

      $('#btnPdf').onclick  = async () => {
        try {
          const id = res.id || res.invoice_id;
          const doc = await getInvoiceJson(id);
          const { jsPDF } = window.jspdf || {};
          const pdf = new jsPDF('p','mm','a4');
          await loadFontsInto(pdf); // üëà –≤–±—É–¥–æ–≤—É—î–º–æ –∫–∏—Ä–∏–ª–∏—á–Ω—ñ —à—Ä–∏—Ñ—Ç–∏
          // –¥–∞–ª—ñ –≥–µ–Ω–µ—Ä—É—î–º–æ –∑ —Ç–∏–º–∏ –∂ —à—Ä–∏—Ñ—Ç–∞–º–∏
          // —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ –∫–æ–¥, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–º–æ doc —â–µ —Ä–∞–∑ —É —Ä–µ–Ω–¥–µ—Ä–µ—Ä:
          // (—Å—Ç–≤–æ—Ä–∏–º–æ –Ω–æ–≤–∏–π —ñ–Ω—Å—Ç–∞–Ω—Å, –±–æ –º–∏ –≤–±—É–¥—É–≤–∞–ª–∏ —à—Ä–∏—Ñ—Ç–∏ —É "pdf" –¥–ª—è —Ü—å–æ–≥–æ –≤–∏–∫–ª–∏–∫—É)
          renderPdfFromJson(doc);
        } catch (e) {
          $('#toast').classList.remove('ok'); $('#toast').classList.add('err');
          $('#toast').textContent = '–ü–æ–º–∏–ª–∫–∞ PDF: ' + e.message;
        }
      };

      $('#btnNew').onclick  = () => location.reload();
    }catch(e){
      $('#result').classList.remove('hidden');
      $('#toast').classList.remove('ok'); $('#toast').classList.add('err');
      $('#toast').textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message;
    }
  };
})();
</script>
</body>
</html>
