<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–∞—Ö—É–Ω–∫—É</title>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --muted:#666; --border:#eee; --accent:#0a7cff; --black:#111; }
    html,body { margin:0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; background:var(--bg); padding:16px; }
    .card { background:var(--card); border-radius:14px; padding:16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); max-width:980px; margin:0 auto; }
    h1 { margin:0 0 12px 0; font-size:22px; }
    fieldset { border:1px solid var(--border); border-radius:10px; margin:12px 0; padding:12px; }
    legend { padding:0 6px; color:#555; }
    .row { display:grid; grid-template-columns: repeat(2,1fr); gap:10px; }
    label { display:block; font-size:12px; color:#555; margin-bottom:4px; }
    input, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid var(--border); padding:8px; vertical-align:top; }
    tfoot td { border:none; }
    .btn { background:var(--black); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:var(--accent); }
    .btn.link { background:transparent; color:var(--accent); border:1px solid var(--accent); }
    .muted { color:var(--muted); font-size:12px; }
    .links a { display:inline-block; margin-right:10px; text-decoration:none; }
    .diag { background:#fafafa; border:1px dashed var(--border); border-radius:10px; padding:10px; margin:10px 0; }
    code { background:#f0f3f6; padding:2px 6px; border-radius:6px; }
    .right { text-align:right; }
  </style>

  <!-- 1) –±–∞–∑–æ–≤—ñ –∞–¥—Ä–µ—Å–∏ -->
  <script src="./webapp_env.js"></script>
  <!-- 2) –º—ñ—Å—Ç –¥–æ Telegram WebApp (–æ–ø—Ü—ñ–π–Ω–æ: –ø—Ä–∞—Ü—é—î, –∫–æ–ª–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç–æ –≤ Telegram) -->
  <script src="./webapp_tg_bridge.js"></script>
</head>
<body>
  <div class="card">
    <h1>–ù–æ–≤–∏–π —Ä–∞—Ö—É–Ω–æ–∫</h1>

    <div class="diag">
      <div class="muted">–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:</div>
      <div>API_BASE: <code id="apiBase">(–≤–∏–∑–Ω–∞—á–∞—é...)</code></div>
      <div>APP_BASE: <code id="appBase">(–≤–∏–∑–Ω–∞—á–∞—é...)</code></div>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
        <button class="btn link" onclick="openHealth()">–í—ñ–¥–∫—Ä–∏—Ç–∏ health</button>
        <button class="btn link" onclick="pingApi()">Ping API</button>
        <button class="btn link" onclick="copyApi()">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ API_BASE</button>
      </div>
      <div id="diagMsg" class="muted" style="margin-top:6px"></div>
    </div>

    <fieldset>
      <legend>–ü—Ä–æ–¥–∞–≤–µ—Ü—å</legend>
      <div class="row">
        <div><label>–ù–∞–∑–≤–∞</label><input id="seller_name" placeholder="–§–û–ü –Ü–≤–∞–Ω–µ–Ω–∫–æ –Ü–≤–∞–Ω"></div>
        <div><label>–ú—ñ—Å—Ç–æ/–∞–¥—Ä–µ—Å–∞</label><input id="seller_addr" placeholder="–ö–∏—ó–≤"></div>
        <div><label>IBAN</label><input id="seller_iban" placeholder="UA..."></div>
        <div><label>–Ñ–î–†–ü–û–£/–Ü–ü–ù</label><input id="seller_tax" placeholder="1234567890"></div>
        <div><label>Email</label><input id="seller_email" placeholder="name@example.com"></div>
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="seller_phone" placeholder="+380..."></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>–ü–æ–∫—É–ø–µ—Ü—å</legend>
      <div class="row">
        <div><label>–ù–∞–∑–≤–∞</label><input id="buyer_name" placeholder="–¢–û–í –†–æ–º–∞—à–∫–∞"></div>
        <div><label>–ê–¥—Ä–µ—Å–∞</label><input id="buyer_addr" placeholder="–õ—å–≤—ñ–≤"></div>
        <div><label>–Ñ–î–†–ü–û–£/–Ü–ü–ù</label><input id="buyer_tax" placeholder="12345678"></div>
        <div><label>Email</label><input id="buyer_email" placeholder="client@example.com"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>–ü–æ–∑–∏—Ü—ñ—ó</legend>
      <table id="items">
        <thead><tr><th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th><th style="width:100px">–ö-—Å—Ç—å</th><th style="width:100px">–û–¥.</th><th style="width:140px">–¶—ñ–Ω–∞</th><th style="width:60px"></th></tr></thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="muted">–§–æ—Ä–º–∞—Ç —Ü—ñ–Ω–∏ —Ç–∞ —Å—É–º: <code>1234,56</code> (–∫–æ–º–∞ —è–∫ —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ –∫–æ–ø—ñ–π–æ–∫)</td>
          </tr>
        </tfoot>
      </table>
      <div style="margin-top:8px">
        <button class="btn secondary" onclick="addRow()">+ –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
        <button class="btn link" onclick="addRow('–ü–æ—Å–ª—É–≥–∏', '1', '—à—Ç', '1000,00')">+ –®–∞–±–ª–æ–Ω</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</legend>
      <div class="row">
        <div>
          <label>–í–∞–ª—é—Ç–∞</label>
          <select id="currency">
            <option value="UAH" selected>UAH</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div><label>–ü—Ä–∏–º—ñ—Ç–∫–∏</label><input id="notes" placeholder="–ë–µ–∑ –ü–î–í"></div>
        <div><label>–ú—ñ—Å—Ç–æ –≤–∏–ø–∏—Å–∫–∏</label><input id="place_city" placeholder="–ö–∏—ó–≤"></div>
      </div>
    </fieldset>

    <div style="display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap">
      <button class="btn" onclick="createInvoice()">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–∞—Ö—É–Ω–æ–∫</button>
      <span id="status" class="muted"></span>
    </div>

    <div id="links" class="links" style="margin-top:10px"></div>
  </div>

<script>
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return [...document.querySelectorAll(sel)]; }
function trimSlash(s){ return (s||"").replace(/\/+$/,''); }

function resolveApiBase() {
  let api = (window.API_BASE || "").trim();
  if (!api && (location.hostname === "127.0.0.1" || location.hostname === "localhost")) {
    api = "http://127.0.0.1:8081";
  }
  return trimSlash(api);
}

function showEnv() {
  const api = resolveApiBase();
  const app = trimSlash(window.APP_BASE || location.origin);
  $("#apiBase").textContent = api || "(–Ω–µ –∑–∞–¥–∞–Ω–æ)";
  $("#appBase").textContent = app || "(–Ω–µ–≤—ñ–¥–æ–º–æ)";
  $("#diagMsg").textContent = api ? "" : "API_BASE –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ webapp_env.js –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π –∞–±–æ –∑–∞–ø—É—Å—Ç—ñ—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ API –Ω–∞ 8081.";
}

function addRow(name="", qty="1", unit="—à—Ç", price="0,00") {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${name}"></td>
    <td><input value="${qty}" style="width:90px"></td>
    <td><input value="${unit}" style="width:90px"></td>
    <td><input value="${price}" style="width:130px"></td>
    <td class="right"><button class="btn" title="–í–∏–¥–∞–ª–∏—Ç–∏" onclick="this.closest('tr').remove()">√ó</button></td>`;
  $('#items tbody').appendChild(tr);
}
addRow();

function openHealth(){
  const api = resolveApiBase();
  if (!api) { alert("API_BASE –Ω–µ –∑–∞–¥–∞–Ω–∏–π"); return; }
  window.open(api + "/health", "_blank");
}

async function pingApi(){
  const api = resolveApiBase();
  if (!api) { $("#diagMsg").textContent = "API_BASE –Ω–µ –∑–∞–¥–∞–Ω–∏–π"; return; }
  $("#diagMsg").textContent = "Ping...";
  try {
    const r = await fetch(api + "/health", {cache:"no-store"});
    const ctype = (r.headers.get("content-type")||"").toLowerCase();
    if (!ctype.includes("application/json")) {
      $("#diagMsg").textContent = "API –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ JSON (–π–º–æ–≤—ñ—Ä–Ω–æ, ¬´welcome/consent¬ª —Å—Ç–æ—Ä—ñ–Ω–∫–∞ ngrok). –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥–∫—Ä–∏—Ç–∏ health¬ª, –ø–æ–≥–æ–¥—å—Ç–µ—Å—è, –ø–æ—Ç—ñ–º ¬´Ping API¬ª.";
      return;
    }
    const j = await r.json();
    $("#diagMsg").textContent = "OK: " + JSON.stringify(j);
  } catch (e) {
    $("#diagMsg").textContent = "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å ping: " + (e.message || e);
  }
}

async function createInvoice(){
  const status = $("#status");
  const api = resolveApiBase();
  if (!api) { status.textContent = "API_BASE –Ω–µ –∑–∞–¥–∞–Ω–∏–π (–ø–µ—Ä–µ–≤—ñ—Ä webapp_env.js)."; return; }

  status.textContent = "–ù–∞–¥—Å–∏–ª–∞—é –¥–∞–Ω—ñ‚Ä¶";

  const items = $all('#items tbody tr').map(tr => {
    const [nameEl, qtyEl, unitEl, priceEl] = tr.querySelectorAll('input');
    return { name: nameEl.value, qty: qtyEl.value, unit: unitEl.value, price: priceEl.value };
  });

  const payload = {
    seller: {
      name: $("#seller_name").value, address: $("#seller_addr").value,
      iban: $("#seller_iban").value, tax_id: $("#seller_tax").value,
      email: $("#seller_email").value, phone: $("#seller_phone").value
    },
    buyer: {
      name: $("#buyer_name").value, address: $("#buyer_addr").value,
      tax_id: $("#buyer_tax").value, email: $("#buyer_email").value
    },
    items,
    invoice: { currency: $("#currency").value, notes: $("#notes").value, place_city: $("#place_city").value }
  };

  try {
    const r = await fetch(api + "/api/invoices", {
      method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(payload)
    });

    const ctype = (r.headers.get("content-type")||"").toLowerCase();
    if (!ctype.includes("application/json")) {
      status.textContent = "API –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ JSON (–º–æ–∂–ª–∏–≤–æ, welcome/consent –≤—ñ–¥ ngrok). –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–í—ñ–¥–∫—Ä–∏—Ç–∏ health¬ª, –ø–æ–≥–æ–¥—å—Ç–µ—Å—è —Ç–∞ –ø–æ–≤—Ç–æ—Ä—ñ—Ç—å.";
      return;
    }

    if (!r.ok) throw new Error("HTTP " + r.status);
    const data = await r.json();

    const links = data.links || {};
    const id = data.id;
    const pdf = links.pdf ? (api + links.pdf) : (api + `/api/invoices/${id}/pdf?dl=1`);
    const html = links.html ? (api + links.html) : (api + `/api/invoices/${id}/html`);

    $("#links").innerHTML = `
      <a class="btn" href="${pdf}" target="_blank" download>‚¨áÔ∏è PDF</a>
      <a class="btn secondary" href="${html}" target="_blank">üîé HTML</a>
    `;
    status.textContent = "–ì–æ—Ç–æ–≤–æ!";
  } catch (e) {
    status.textContent = "–ü–æ–º–∏–ª–∫–∞: " + (e.message || e);
  }
}

async function copyApi(){
  const api = resolveApiBase();
  if (!api) { alert("API_BASE –Ω–µ –∑–∞–¥–∞–Ω–∏–π"); return; }
  try {
    await navigator.clipboard.writeText(api);
    $("#diagMsg").textContent = "API_BASE —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.";
  } catch {
    $("#diagMsg").textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ API_BASE.";
  }
}

showEnv();
</script>
</body>
</html>
