<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InvoUA — Створити рахунок</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f6f7fb;color:#111;margin:0}
    .wrap{max-width:980px;margin:16px auto;padding:12px}
    .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:18px}
    h1{margin:0 0 12px 0;font-size:26px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px;min-width:260px}
    label{display:block;font-size:12px;color:#555;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d8dde7;border-radius:10px;font-size:15px;box-sizing:border-box;background:#fff}
    .muted{color:#8a8f99;font-size:12px}
    .warn{color:#d7263d;font-weight:600}
    .btn{display:inline-block;padding:12px 16px;border-radius:12px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
    .small{font-size:12px}
    .apihint a{color:#2563eb;text-decoration:none}
    .ok{color:#059669}
    .err{color:#dc2626}
  </style>
  <script>
    // ---------- середовище ----------
    let API_BASE = "";
    let APP_BASE = "";

    // 1) з webapp_env.js (генерується з PowerShell)
  </script>
  <script src="./webapp_env.js"></script>
  <script>
    (function bootstrapEnv(){
      try { if (window.API_BASE) API_BASE = String(window.API_BASE).replace(/\/+$/,''); } catch(e){}
      try { if (window.APP_BASE) APP_BASE = String(window.APP_BASE).replace(/\/+$/,''); } catch(e){}

      // 2) дозволимо перевизначити через query (?api=..., ?app=...)
      const u = new URL(location.href);
      if (u.searchParams.get("api")) API_BASE = u.searchParams.get("api").replace(/\/+$/,'');
      if (u.searchParams.get("app")) APP_BASE = u.searchParams.get("app").replace(/\/+$/,'');

      // 3) якщо API_BASE відсутній — покажемо в інтерфейсі
      window.__env__ = { API_BASE, APP_BASE };
    })();

    // ---------- Telegram bridge для sendData ----------
    (function bridge(){
      const tg = window.Telegram && window.Telegram.WebApp;
      function sendToBot(payload){
        try { tg && tg.sendData && tg.sendData(JSON.stringify(payload)); } catch(e){}
      }
      // перехоплення fetch
      const origFetch = window.fetch;
      if (origFetch){
        window.fetch = async function(input, init={}){
          init.headers = Object.assign({}, init.headers, {"ngrok-skip-browser-warning":"1"});
          const res = await origFetch(input, init);
          try{
            const url = typeof input==='string' ? input : (input && input.url) || '';
            const method = (init && init.method ? String(init.method).toUpperCase() : 'GET');
            if (/\/api\/invoices(\?|$)/i.test(url) && method==='POST' && res.ok){
              const clone = res.clone();
              const data = await clone.json().catch(()=>null);
              if (data && data.id){
                sendToBot({type:'invoice_created', id:data.id, number:data.number, html_url:data.public_url, pdf_url:data.pdf_url});
              }
            }
          }catch(e){}
          return res;
        };
      }
      // перехоплення XHR (на всяк випадок)
      (function(){
        const X = window.XMLHttpRequest; if (!X) return;
        const o = X.prototype.open, s = X.prototype.send;
        X.prototype.open = function(m,u){ this.__meta={m:String(m||'').toUpperCase(),u:String(u||'')}; return o.apply(this, arguments); };
        X.prototype.send = function(b){
          try{ this.setRequestHeader("ngrok-skip-browser-warning","1"); }catch(e){}
          this.addEventListener('readystatechange', ()=>{
            if (this.readyState===4){
              try{
                const meta=this.__meta||{};
                if (/\/api\/invoices(\?|$)/i.test(meta.u) && meta.m==='POST' && this.status>=200 && this.status<300){
                  const data = JSON.parse(this.responseText);
                  if (data && data.id){
                    const tg = window.Telegram && window.Telegram.WebApp;
                    tg && tg.sendData && tg.sendData(JSON.stringify({type:'invoice_created', id:data.id, number:data.number, html_url:data.public_url, pdf_url:data.pdf_url}));
                  }
                }
              }catch(e){}
            }
          });
          return s.apply(this, arguments);
        };
      })();
    })();

    // ---------- UI / логіка форми ----------
    async function pingApi(){
      const el = document.getElementById('apiStatus');
      if (!__env__.API_BASE){
        el.innerHTML = `<span class="err">API не налаштовано</span>`;
        return false;
      }
      try{
        const r = await fetch(`${__env__.API_BASE}/health`, { headers: { "ngrok-skip-browser-warning":"1" }});
        if (!r.ok){ el.innerHTML = `<span class="err">API недоступний (${r.status})</span>`; return false; }
        const j = await r.json();
        el.innerHTML = `<span class="ok">OK</span>`;
        return j && j.status==='ok';
      }catch(e){
        el.innerHTML = `<span class="err">API недоступний: ${e}</span>`;
        return false;
      }
    }

    async function createInvoice(ev){
      ev.preventDefault();
      const btn = document.getElementById('btnCreate');
      btn.disabled = true;

      const f = ev.target;
      const payload = {
        seller_name:   f.seller_name.value.trim(),
        buyer_name:    f.buyer_name.value.trim(),
        currency:      f.currency.value,
        note:          f.note.value.trim(),
        items: [
          { name: f.item1.value.trim(), qty: Number(f.qty1.value||1), unit: f.unit1.value.trim(), price: f.price1.value.trim() }
        ]
      };

      try{
        const r = await fetch(`${__env__.API_BASE}/api/invoices`, {
          method:'POST',
          headers:{
            "Content-Type":"application/json",
            "ngrok-skip-browser-warning":"1"
          },
          body: JSON.stringify(payload),
        });
        if (!r.ok){
          const txt = await r.text();
          throw new Error(`HTTP ${r.status}: ${txt}`);
        }
        const data = await r.json();
        // покажемо коротко і дамо посилання як запасний варіант
        const out = document.getElementById('result');
        const pdfUrl = `${__env__.API_BASE}/api/invoices/${data.id}/pdf?dl=1`;
        out.innerHTML = `
          <div class="small">ID: <code>${data.id}</code></div>
          <a class="small" href="${pdfUrl}" target="_blank" rel="noopener">Відкрити PDF</a>
        `;
      }catch(e){
        alert("Помилка мережі або CORS. Деталі в консолі.");
        console.error("Create invoice failed:", e);
      }finally{
        btn.disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // заповнимо рядок статусу
      document.getElementById('apiBase').textContent = __env__.API_BASE || '—';
      pingApi();

      // форма
      document.getElementById('f').addEventListener('submit', createInvoice);
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>Створити рахунок</h1>
      <div class="small apihint">
        API: <code id="apiBase">—</code> • Статус: <span id="apiStatus" class="muted">перевіряю…</span>
      </div>
    </div>

    <div class="card">
      <form id="f">
        <div class="row">
          <div class="col">
            <label>Продавець — Назва</label>
            <input name="seller_name" placeholder="ТОВ Приклад" />
          </div>
          <div class="col">
            <label>Покупець — Назва</label>
            <input name="buyer_name" placeholder="ТОВ Замовник" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Валюта</label>
            <select name="currency">
              <option value="UAH">UAH</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
          <div class="col">
            <label>Нотатки (необов’язково)</label>
            <input name="note" placeholder="Без ПДВ / підпис/печатка" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Найменування</label>
            <input name="item1" placeholder="Послуга/Товар" />
          </div>
          <div class="col">
            <label>К-сть</label>
            <input name="qty1" value="1" />
          </div>
          <div class="col">
            <label>Од.</label>
            <input name="unit1" value="шт" />
          </div>
          <div class="col">
            <label>Ціна</label>
            <input name="price1" placeholder="1000,00" />
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;align-items:center;">
          <button id="btnCreate" class="btn" type="submit">Створити рахунок</button>
          <span id="result" class="small muted"></span>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
