<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InvoUA — Створення рахунку</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* мінімальний стиль — не змінює логіку */
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "DejaVu Sans", Arial; background:#0f1724; color:#e6eef8; padding:18px; }
    .warn { color:#ffb4b4; margin-bottom:12px; }
    .small { font-size:12px; color:#aab6c6; }
    .form { background:#081225; padding:12px; border-radius:8px; }
    .btn { display:inline-block; padding:10px 14px; background:#0ea5a3; color:#012; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Створення рахунку</h1>

  <div id="info" class="small"></div>

  <div class="form">
    <!-- simplified form demo (твій повний UI лишаємо як зараз) -->
    <label>Назва продавця<br /><input id="seller_name" value="" /></label><br/><br/>
    <label>Покупець<br /><input id="buyer_name" value="" /></label><br/><br/>
    <label>Позиція<br /><input id="item_name" value="Послуги обліку" /></label><br/><br/>
    <label>Ціна<br /><input id="price" value="1000,00" /></label><br/><br/>
    <div><button id="create" class="btn">Створити рахунок</button></div>
  </div>

  <script>
  // --- налаштування BASE (буде перезаписано webapp_env.js якщо присутній) ---
  if (!window.API_BASE) window.API_BASE = "http://127.0.0.1:8081";
  if (!window.APP_BASE) window.APP_BASE = location.origin;

  // show current values (debug)
  const info = document.getElementById('info');
  function showInfo() {
    info.innerHTML = `<div class="small">APP_BASE: <code>${window.APP_BASE}</code><br>API_BASE: <code>${window.API_BASE}</code></div>`;
  }
  showInfo();

  // --- helper: full URL builder ---
  function apiUrl(path) {
    if (!path) path = "";
    // allow path with leading slash
    return (window.API_BASE.replace(/\/+$/, '')) + (path.startsWith('/') ? path : ('/' + path));
  }

  // --- GLOBAL fetch wrapper: додає заголовок, щоб ngrok не показував "visit site" ---
  (function() {
    const origFetch = window.fetch;
    if (!origFetch) return;
    window.fetch = async function(input, init = {}) {
      try {
        let url = (typeof input === 'string') ? input : (input && input.url) || '';
        // якщо це відправка до API_BASE — додати заголовок обходу ngrok warning
        const targetHost = (window.API_BASE || '').toLowerCase();
        if (targetHost && url && url.toLowerCase().startsWith(targetHost)) {
          init.headers = init.headers || {};
          // ngrok skip header — будь-яке значення
          init.headers['ngrok-skip-browser-warning'] = 'true';
          // CORS mode
          init.mode = init.mode || 'cors';
        }
      } catch (e) { /* ignore */ }
      return origFetch.apply(this, arguments);
    };
  })();

  // --- XHR wrapper: додає заголовок для старих кодів (optional) ---
  (function() {
    const XHR = window.XMLHttpRequest;
    if (!XHR) return;
    const origOpen = XHR.prototype.open;
    const origSend = XHR.prototype.send;
    XHR.prototype.open = function(method, url) {
      this.__invo_meta = { method: (method||'').toUpperCase(), url: url || '' };
      return origOpen.apply(this, arguments);
    };
    XHR.prototype.send = function(body) {
      try {
        const meta = this.__invo_meta || {};
        // перехопимо addEventListener, додамо заголовок перед викликом send
        const origSetRequestHeader = this.setRequestHeader;
        const self = this;
        this.setRequestHeader = function(name, value) {
          origSetRequestHeader.apply(self, arguments);
        };
        this.addEventListener('readystatechange', function() {
          // нічого тут не робимо — заголовок додамо перед відправкою
        });
        // додаємо заголовок якщо URL містить API_BASE
        const targetHost = (window.API_BASE || '').toLowerCase();
        if (targetHost && meta.url && String(meta.url).toLowerCase().startsWith(targetHost)) {
          try { origSetRequestHeader.call(self, 'ngrok-skip-browser-warning', 'true'); } catch (e) {}
        }
      } catch(e){}
      return origSend.apply(this, arguments);
    };
  })();

  // --- Telegram WebApp bridge sender (для бот-інтеграції) ---
  function sendToBot(payload) {
    try {
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.sendData) {
        window.Telegram.WebApp.sendData(JSON.stringify(payload));
      } else {
        // debug fallback
        console.log('No Telegram.WebApp (sendData) available — payload:', payload);
      }
    } catch(e){ console.warn(e); }
  }

  // --- перехоплюємо локальний POST /api/invoices щоб відправити повідомлення боту ---
  (function() {
    const origFetch = window.fetch;
    if (!origFetch) return;
    window.fetch = async function(input, init = {}) {
      const res = await origFetch(input, init);
      try {
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        const method = (init && init.method) ? String(init.method).toUpperCase() : 'GET';
        if (/\/api\/invoices(\?|$)/i.test(url) && method === 'POST' && res.ok) {
          const clone = res.clone();
          const data = await clone.json().catch(()=>null);
          if (data && data.id) {
            sendToBot({
              type: 'invoice_created',
              id: data.id,
              number: (data.invoice && data.invoice.number) || data.number || '',
              html_url: (data.links && data.links.html) || data.public_url || '',
              pdf_url: (data.links && data.links.pdf) || data.pdf_url || ''
            });
          }
        }
      } catch(e) { console.warn(e) }
      return res;
    };
  })();

  // --- minimal form submit: використовує API_BASE та додає заголовок через wrapper ---
  document.getElementById('create').addEventListener('click', async function() {
    const body = {
      seller: { name: document.getElementById('seller_name').value || '' },
      buyer: { name: document.getElementById('buyer_name').value || '' },
      items: [{ name: document.getElementById('item_name').value || 'Послуга', qty: "1", unit: "шт", price: document.getElementById('price').value || "0,00" }],
      invoice: { currency: "UAH", notes: "" }
    };
    try {
      const url = apiUrl('/api/invoices');
      const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (!r.ok) {
        const txt = await r.text().catch(()=>null);
        alert('Помилка створення: ' + (txt || r.status));
        return;
      }
      const data = await r.json();
      alert('Рахунок створено: ' + (data.id || data.invoice && data.invoice.number || 'ok'));
      // якщо бот не отримав — відправим ще раз на всякий
      sendToBot({ type:'invoice_created', id: data.id, number: data.invoice && data.invoice.number, html_url: data.links && data.links.html, pdf_url: data.links && data.links.pdf });
    } catch (e) {
      console.error(e);
      alert('Помилка мережі або CORS. Подивись консоль.');
    }
  });

  </script>
</body>
</html>
