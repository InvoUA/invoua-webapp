<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>InvoUA — рахунок за 60 секунд</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding:14px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    label { font-size:12px; color:#444; display:block; margin-top:10px; }
    input, select { width:100%; padding:7px 9px; border:1px solid #ddd; border-radius:6px; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border:1px solid #e6e6e6; padding:6px; }
    .actions { display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; }
    button { padding:8px 12px; border:0; border-radius:18px; background:#1971ff; color:#fff; cursor:pointer; }
    button.secondary { background:#eee; color:#333; }
    .muted { color:#666; font-size:12px; }
    .error { color:#b00020; margin-top:10px; }
  </style>
</head>
<body>

<h1>InvoUA — рахунок за 60 секунд <small style="color:#888; font-size:12px;">/ v2.3</small></h1>

<!-- ───────────────────────────────────────── Продавець ───────────────────── -->
<section>
  <h3>Продавець</h3>
  <div class="row">
    <div>
      <label>Назва <input id="s_name"></label>
      <label>IBAN <input id="s_iban"></label>
      <label>Адреса <input id="s_addr"></label>
      <label>Телефон <input id="s_phone"></label>
      <label>Печатка URL <input id="s_stamp"></label>
    </div>
    <div>
      <label>ЄДРПОУ/ІПН <input id="s_tax"></label>
      <label>Банк <input id="s_bank"></label>
      <label>Email <input id="s_email"></label>
      <label>Лого URL <input id="s_logo"></label>
      <label>Підпис URL <input id="s_sign"></label>
    </div>
  </div>
  <div class="actions"><button id="btnSaveSeller" class="secondary">Зберегти продавця</button></div>
</section>

<!-- ───────────────────────────────────────── Рахунок ──────────────────────── -->
<section>
  <h3>Рахунок</h3>
  <div class="row">
    <label>Покупець (назва/ПІБ) <input id="b_name"></label>
    <label>Валюта
      <select id="inv_curr">
        <option>UAH</option>
        <option>USD</option>
        <option>EUR</option>
      </select>
    </label>
  </div>

  <table id="tbl">
    <thead>
      <tr><th>Найменування</th><th style="width:80px">К-сть</th><th style="width:70px">Од.</th><th style="width:140px">Ціна</th><th style="width:40px"></th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="actions">
    <button class="secondary" id="btnAdd">+ Додати позицію</button>
    <button id="btnSave">Зберегти рахунок</button>
  </div>

  <div class="actions">
    <button class="secondary" id="btnOpenHtml">Відкрити HTML</button>
    <button id="btnOpenPdf">Відкрити PDF (сервер)</button>
    <button class="secondary" id="btnLocalPdf">Завантажити PDF (локально)</button>
    <button class="secondary" id="btnNew">Новий</button>
  </div>

  <div id="err" class="error"></div>
  <p class="muted">API-адреса береться з параметра <code>?api=</code>. Якщо працюєш через ngrok — ми додаємо <code>ngrok-skip-browser-warning=1</code> автоматично.</p>
</section>

<script>
// ---- Wipe mode ----
(async function wipeIfAsked(){
  const qs = new URLSearchParams(location.search);
  if (!qs.has('wipe') && !qs.has('wipe_fonts')) return;

  try {
    if (window.caches && caches.keys) {
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n).catch(()=>{})));
    }
    if (window.indexedDB && indexedDB.databases) {
      const dbs = await indexedDB.databases();
      await Promise.all((dbs||[]).map(d => new Promise(res=>{
        const req = indexedDB.deleteDatabase(d.name); req.onsuccess = req.onerror = req.onblocked = ()=>res();
      })));
    }
    try { localStorage.clear(); } catch(_){}
    try { sessionStorage.clear(); } catch(_){}
  } catch(e) { console.warn('Wipe error:', e); }

  qs.delete('wipe'); qs.delete('wipe_fonts');
  if (!qs.has('v')) qs.set('v', Date.now());
  location.replace(location.pathname + '?' + qs.toString());
})();

// ---- Утиліти ----
function apiBase() {
  const api = new URLSearchParams(location.search).get('api') || '';
  return api ? new URL(api, location.href) : new URL(location.origin);
}
function apiUrl(pathOrUrl) {
  const base = apiBase();
  const url = new URL(pathOrUrl, base);
  url.searchParams.set('ngrok-skip-browser-warning', '1');
  return url.toString();
}
async function fetchJSON(path, opts={}) {
  const r = await fetch(apiUrl(path), { headers: { 'Content-Type':'application/json' }, ...opts });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}
function row(data={name:'', qty:1, unit:'se', price:0}) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input value="${data.name||''}"></td>
    <td><input style="width:70px" type="number" step="0.01" value="${data.qty||1}"></td>
    <td><input style="width:60px" value="${data.unit||'se'}"></td>
    <td><input style="width:120px" type="number" step="0.01" value="${data.price||0}"></td>
    <td><button class="secondary">x</button></td>`;
  tr.querySelector('button').onclick = () => tr.remove();
  return tr;
}
function readItems() {
  const items = [];
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    const [name, qty, unit, price] = [...tr.querySelectorAll('input')].map(i=>i.value.trim());
    if (name) items.push({name, qty: +qty||1, unit: unit||'se', price: +price||0});
  });
  return items;
}
function sellerFromForm() {
  return {
    name:  document.getElementById('s_name').value.trim(),
    iban:  document.getElementById('s_iban').value.trim(),
    address: document.getElementById('s_addr').value.trim(),
    phone: document.getElementById('s_phone').value.trim(),
    tax_id: document.getElementById('s_tax').value.trim(),
    bank: document.getElementById('s_bank').value.trim(),
    email: document.getElementById('s_email').value.trim(),
    logo_url: document.getElementById('s_logo').value.trim(),
    stamp_url: document.getElementById('s_stamp').value.trim(),
    sign_url: document.getElementById('s_sign').value.trim(),
  };
}
function fillSeller(s) {
  document.getElementById('s_name').value = s.name||'';
  document.getElementById('s_iban').value = s.iban||'';
  document.getElementById('s_addr').value = s.address||'';
  document.getElementById('s_phone').value = s.phone||'';
  document.getElementById('s_tax').value = s.tax_id||'';
  document.getElementById('s_bank').value = s.bank||'';
  document.getElementById('s_email').value = s.email||'';
  document.getElementById('s_logo').value = s.logo_url||'';
  document.getElementById('s_stamp').value = s.stamp_url||'';
  document.getElementById('s_sign').value = s.sign_url||'';
}

// ---- Завантажити/зберегти продавця ----
async function loadSeller() {
  try {
    const s = await fetchJSON('/api/seller');
    fillSeller(s || {});
  } catch(e) {
    console.warn('seller get fail', e);
  }
}
async function saveSeller() {
  const s = sellerFromForm();
  await fetch(apiUrl('/api/seller'), {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(s)});
}

// ---- Події інтерфейсу ----
document.getElementById('btnAdd').onclick = () => {
  document.querySelector('#tbl tbody').appendChild(row({}));
};

document.getElementById('btnSaveSeller').onclick = async () => {
  try { await saveSeller(); msg('Реквізити продавця збережено.'); }
  catch(e){ msg('Помилка збереження: '+e.message); }
};

document.getElementById('btnSave').onclick = async () => {
  try{
    const payload = {
      seller: sellerFromForm(),
      buyer: { name: document.getElementById('b_name').value.trim() },
      invoice: { currency: document.getElementById('inv_curr').value },
      items: readItems()
    };
    const r = await fetch(apiUrl('/api/invoices'), {method:'POST', body: JSON.stringify(payload), headers:{'Content-Type': 'application/json'}});
    const j = await r.json();
    if(!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);

    // збережемо для наступних дій
    window._lastInvoice = j;
    msg(`Збережено: ${j.number}`);
  }catch(e){
    msg('Помилка збереження: '+e.message);
  }
};

document.getElementById('btnOpenHtml').onclick = () => {
  const inv = window._lastInvoice;
  if(!inv) return msg('Спочатку збережи рахунок.');
  window.open(apiUrl(`/api/invoices/${inv.id}/html`), '_blank', 'noopener');
};

document.getElementById('btnOpenPdf').onclick = () => {
  const inv = window._lastInvoice;
  if(!inv) return msg('Спочатку збережи рахунок.');
  // важливо: відкриваємо саме наш /pdf_page через apiUrl → це гарантує skip-param і правильний хост
  window.open(apiUrl(`/api/invoices/${inv.id}/pdf_page`), '_blank', 'noopener');
};

document.getElementById('btnLocalPdf').onclick = async () => {
  try{
    // шрифти беруться з GH Pages (не через ngrok)
    const [reg, bold] = await Promise.all([
      fetch('fonts/DejaVuSans.ttf').then(r=>r.arrayBuffer()),
      fetch('fonts/DejaVuSans-Bold.ttf').then(r=>r.arrayBuffer()),
    ]);

    const jsPDF = window.jspdf.jsPDF;
    const pdf = new jsPDF({unit:'pt', format:'a4'});

    // додати шрифти у VFS
    pdf.addFileToVFS('DejaVuSans.ttf', arrayBufferToBase64(reg));
    pdf.addFileToVFS('DejaVuSans-Bold.ttf', arrayBufferToBase64(bold));
    pdf.addFont('DejaVuSans.ttf', 'DejaVu', 'normal');
    pdf.addFont('DejaVuSans-Bold.ttf', 'DejaVu', 'bold');

    pdf.setFont('DejaVu','bold'); pdf.setFontSize(16);
    const inv = window._lastInvoice;
    const number = inv?.number || 'INV';
    pdf.text(`Рахунок # ${number}`, 40, 60);

    pdf.setFont('DejaVu','normal'); pdf.setFontSize(11);
    const s = sellerFromForm();
    pdf.text(`Продавець: ${s.name || ''}`, 40, 84);

    pdf.save(`invoice-${number}.pdf`);
  }catch(e){
    msg('Помилка локального PDF: ' + e.message);
  }
};

document.getElementById('btnNew').onclick = async () => {
  document.querySelector('#tbl tbody').innerHTML = '';
  document.querySelector('#tbl tbody').appendChild(row({}));
  await loadSeller();
  window._lastInvoice = null;
  msg('Нова форма.');
};

function msg(t){ document.getElementById('err').textContent = t; }

// helpers
function arrayBufferToBase64(buffer) {
  let binary = '';
  let bytes = new Uint8Array(buffer);
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

// старт
(function init(){
  document.querySelector('#tbl tbody').appendChild(row({name:'Консультаційні послуги', qty:1, unit:'se', price:1200}));
  document.querySelector('#tbl tbody').appendChild(row({name:'Реклама', qty:1, unit:'se', price:500}));
  loadSeller();
})();
</script>

<!-- jsPDF (без зброї стилів, як є) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</body>
</html>
