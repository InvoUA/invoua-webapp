<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<title>InvoUA — рахунок за 60 секунд</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .col{flex:1 1 380px}
  input,select,button{font:inherit;padding:8px;border:1px solid #ccc;border-radius:8px;width:100%}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #ddd;padding:6px}
  .right{text-align:right}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .hint{font-size:12px;color:#666;margin-top:10px}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eef}
</style>
</head>
<body>

<h2>InvoUA — рахунок за 60 секунд <span class="badge">v2.3</span></h2>

<div class="row">
  <div class="col">
    <h3>Продавець</h3>
    <label>Назва <input id="seller_name"></label>
    <label>ЄДРПОУ/ІПН <input id="seller_tax"></label>
    <label>IBAN <input id="seller_iban"></label>
    <label>Банк <input id="seller_bank"></label>
    <label>Адреса <input id="seller_addr"></label>
    <label>Email <input id="seller_email"></label>
    <label>Телефон <input id="seller_phone"></label>
    <label>Лого URL <input id="seller_logo"></label>
    <label>Печатка URL <input id="seller_stamp"></label>
    <label>Підпис URL <input id="seller_sign"></label>
    <button id="btn_save_seller">Зберегти продавця</button>
  </div>

  <div class="col">
    <h3>Рахунок</h3>
    <label>Покупець (назва/ПІБ) <input id="buyer_name"></label>
    <label>Валюта
      <select id="currency">
        <option>UAH</option><option>USD</option><option>EUR</option>
      </select>
    </label>

    <table id="items">
      <thead><tr><th>Найменування</th><th style="width:80px">К-сть</th><th style="width:70px">Од.</th><th style="width:120px">Ціна</th><th style="width:40px"></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="actions">
      <button id="btn_add">+ Додати позицію</button>
      <button id="btn_save">Зберегти рахунок</button>
      <button id="btn_html">Відкрити HTML</button>
      <button id="btn_pdf_srv">Відкрити PDF (сервер)</button>
      <button id="btn_pdf_local">Завантажити PDF (локально)</button>
      <button id="btn_new">Новий</button>
    </div>
    <div id="msg" class="hint"></div>
    <div class="hint">API-адреса береться з параметра <code>api=</code>. Працюємо через fetch з заголовком <code>ngrok-skip-browser-warning: 1</code> — splash не з'явиться.</div>
  </div>
</div>

<script>
// ---- Wipe mode (очищення кешів/IDB/Storage): додай ?wipe=1
(async function wipeIfAsked(){
  const qs = new URLSearchParams(location.search);
  if (!qs.has('wipe') && !qs.has('wipe_fonts')) return;
  try {
    if (window.caches && caches.keys) {
      const names = await caches.keys();
      await Promise.all(names.map(n => caches.delete(n).catch(()=>{})));
    }
    if (self.indexedDB && indexedDB.databases) {
      const dbs = await indexedDB.databases();
      await Promise.all((dbs||[]).map(d => new Promise(res=>{
        const req = indexedDB.deleteDatabase(d.name); req.onsuccess = req.onerror = req.onblocked = ()=>res();
      })));
    }
    try { localStorage.clear(); } catch(_){}
    try { sessionStorage.clear(); } catch(_){}
  } catch(e) { console.warn('Wipe error:', e); }
  qs.delete('wipe');
  if (!qs.has('v')) qs.set('v', Date.now());
  location.replace(location.pathname + '?' + qs.toString());
})();

// ---- utils
const $ = sel => document.querySelector(sel);
const msg = (t, isErr=false) => { const el = $('#msg'); el.textContent = t; el.style.color = isErr ? '#b00' : '#555'; };

function getApiBase(){
  const qs = new URLSearchParams(location.search);
  const u = (qs.get('api')||'').trim();
  if(!u){ throw new Error('Не задано ?api= у URL'); }
  return u.replace(/^http:\/\//,'https://'); // форсуємо https
}
function addNgrokParam(url){
  const u = new URL(url);
  if(!u.searchParams.has('ngrok-skip-browser-warning')) u.searchParams.set('ngrok-skip-browser-warning','1');
  return u.toString();
}
async function apiFetch(path, opts={}){
  const base = getApiBase();
  const url = addNgrokParam(`${base}${path}`);
  const headers = Object.assign({'Content-Type':'application/json','ngrok-skip-browser-warning':'1'}, opts.headers||{});
  const res = await fetch(url, {...opts, headers});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res;
}

// ---- наповнення/читання форми
function readItems(){
  const out = [];
  $('#items tbody').querySelectorAll('tr').forEach(tr=>{
    out.push({
      name: tr.querySelector('.nm').value.trim(),
      qty: Number(tr.querySelector('.qty').value||0),
      unit: tr.querySelector('.unit').value.trim(),
      price: Number(tr.querySelector('.price').value||0),
    });
  });
  return out;
}
function addRow(v={name:'',qty:1,unit:'se',price:0}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="nm" value="${v.name||''}"></td>
    <td><input class="qty" type="number" step="0.01" value="${v.qty||1}"></td>
    <td><input class="unit" value="${v.unit||'se'}"></td>
    <td><input class="price" type="number" step="0.01" value="${v.price||0}"></td>
    <td><button class="rm">x</button></td>`;
  tr.querySelector('.rm').onclick = ()=>{ tr.remove(); };
  $('#items tbody').appendChild(tr);
}

// ---- seller
async function loadSeller(){
  try{
    const r = await apiFetch('/api/seller', { method:'GET' });
    const s = await r.json();
    $('#seller_name').value  = s.name||'';
    $('#seller_tax').value   = s.tax_id||'';
    $('#seller_iban').value  = s.iban||'';
    $('#seller_bank').value  = s.bank||'';
    $('#seller_addr').value  = s.address||'';
    $('#seller_email').value = s.email||'';
    $('#seller_phone').value = s.phone||'';
    $('#seller_logo').value  = s.logo_url||'';
    $('#seller_stamp').value = s.stamp_url||'';
    $('#seller_sign').value  = s.sign_url||'';
  }catch(e){ msg('Помилка завантаження продавця', true); }
}
async function saveSeller(){
  const body = {
    name: $('#seller_name').value.trim(),
    tax_id: $('#seller_tax').value.trim(),
    iban: $('#seller_iban').value.trim(),
    bank: $('#seller_bank').value.trim(),
    address: $('#seller_addr').value.trim(),
    email: $('#seller_email').value.trim(),
    phone: $('#seller_phone').value.trim(),
    logo_url: $('#seller_logo').value.trim(),
    stamp_url: $('#seller_stamp').value.trim(),
    sign_url: $('#seller_sign').value.trim(),
  };
  try{
    await apiFetch('/api/seller', { method:'PUT', body: JSON.stringify(body) });
    msg('Збережено продавця');
  }catch(e){ msg('Помилка збереження продавця', true); }
}

// ---- створення інвойса (тільки збереження + URL-и)
async function createInvoice(){
  const body = {
    seller: {
      name: $('#seller_name').value.trim(),
      tax_id: $('#seller_tax').value.trim(),
      iban: $('#seller_iban').value.trim(),
      bank: $('#seller_bank').value.trim(),
      address: $('#seller_addr').value.trim(),
      email: $('#seller_email').value.trim(),
      phone: $('#seller_phone').value.trim(),
      logo_url: $('#seller_logo').value.trim(),
      stamp_url: $('#seller_stamp').value.trim(),
      sign_url: $('#seller_sign').value.trim(),
    },
    buyer: { name: $('#buyer_name').value.trim(), address:'', email:'', phone:'' },
    invoice: { currency: $('#currency').value },
    items: readItems()
  };
  const res = await apiFetch('/api/invoices', { method:'POST', body: JSON.stringify(body) });
  return await res.json();
}

// ---- відкриття HTML/PDF БЕЗ splash (через fetch)
async function openHtmlViaFetch(public_url){
  try{
    const u = addNgrokParam(public_url);
    const r = await fetch(u, { headers: {'ngrok-skip-browser-warning': '1'} });
    const html = await r.text();
    const w = window.open('', '_blank');
    w.document.open(); w.document.write(html); w.document.close();
  }catch(e){ msg('Помилка відкриття HTML', true); }
}
async function openPdfViaFetch(pdf_url, fname){
  try{
    const u = addNgrokParam(pdf_url);
    const r = await fetch(u, { headers: {'ngrok-skip-browser-warning': '1'} });
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fname || 'invoice.pdf';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
  }catch(e){ msg('Помилка відкриття PDF', true); }
}

// ---- локальний PDF через jsPDF + DejaVu
async function loadFontAsBase64(url){
  const r = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now());
  const ab = await r.arrayBuffer();
  // перетворення у base64
  let binary = '';
  const bytes = new Uint8Array(ab);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
async function buildLocalPdf(){
  // jsPDF з CDN
  if (!window.jspdf) {
    await new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js";
      s.onload = res; s.onerror = rej; document.head.appendChild(s);
    });
  }
  const { jsPDF } = window.jspdf;

  // шрифти з /fonts поряд з цією сторінкою (GitHub Pages)
  const dejavu = await loadFontAsBase64('fonts/DejaVuSans.ttf');
  const dejavuBold = await loadFontAsBase64('fonts/DejaVuSans-Bold.ttf');

  const doc = new jsPDF({ unit:'mm', format:'a4', compress:true });
  doc.addFileToVFS('DejaVuSans.ttf', dejavu);
  doc.addFileToVFS('DejaVuSans-Bold.ttf', dejavuBold);
  doc.addFont('DejaVuSans.ttf','DejaVu','normal');
  doc.addFont('DejaVuSans-Bold.ttf','DejaVu','bold');
  doc.setFont('DejaVu','bold');
  doc.setFontSize(16);

  const items = readItems();
  const curr = $('#currency').value;
  const number = 'LOC-' + Date.now();

  let x = 20, y = 20;
  doc.text(`Рахунок # ${number}`, x, y); y += 6;
  doc.setFont('DejaVu','normal'); doc.setFontSize(11);
  doc.text(`Дата: ${new Date().toLocaleDateString('uk-UA')}`, x, y); y += 10;

  // таблиця
  doc.setFont('DejaVu','bold'); doc.text('Найменування', x, y);
  doc.text('К-сть', 120, y, {align:'right'});
  doc.text('Од.', 140, y);
  doc.text('Ціна', 160, y, {align:'right'});
  doc.text('Сума', 190, y, {align:'right'}); y += 5;
  doc.setLineWidth(0.1); doc.line(x, y, 190, y); y += 5;

  doc.setFont('DejaVu','normal');
  let subtotal = 0;
  for(const it of items){
    const lineTotal = (Number(it.qty||0)*Number(it.price||0));
    subtotal += lineTotal;
    doc.text(String(it.name||''), x, y);
    doc.text(String(it.qty||0), 120, y, {align:'right'});
    doc.text(String(it.unit||''), 140, y);
    doc.text(`${Number(it.price||0).toFixed(2)} ${curr}`, 160, y, {align:'right'});
    doc.text(`${lineTotal.toFixed(2)} ${curr}`, 190, y, {align:'right'});
    y += 6;
  }
  y += 4;
  doc.setFont('DejaVu','bold');
  doc.text('Проміжний підсумок:', 150, y, {align:'right'});
  doc.text(`${subtotal.toFixed(2)} ${curr}`, 190, y, {align:'right'}); y += 6;
  doc.text('До оплати:', 150, y, {align:'right'});
  doc.text(`${subtotal.toFixed(2)} ${curr}`, 190, y, {align:'right'});

  doc.save(`invoice_${number}.pdf`);
}

// ---- кнопки
$('#btn_add').onclick = ()=> addRow({qty:1, unit:'se', price:0});
$('#btn_save_seller').onclick = ()=> saveSeller();
$('#btn_save').onclick = async ()=>{
  try{
    msg('Зберігаю рахунок…');
    const r = await createInvoice();
    window.__last = r;
    msg('Готово. Можна відкривати HTML або PDF.');
  }catch(e){ msg('Помилка збереження: ' + e.message, true); }
};
$('#btn_html').onclick = async ()=>{
  if(!window.__last){ msg('Спершу збережи рахунок', true); return; }
  await openHtmlViaFetch(window.__last.public_url);
};
$('#btn_pdf_srv').onclick = async ()=>{
  if(!window.__last){ msg('Спершу збережи рахунок', true); return; }
  await openPdfViaFetch(window.__last.pdf_url, `invoice_${window.__last.number}.pdf`);
};
$('#btn_pdf_local').onclick = async ()=>{
  try{
    await buildLocalPdf();
  }catch(e){
    msg(`Помилка локального PDF: ${e.message}`, true);
  }
};
$('#btn_new').onclick = async ()=>{
  $('#items tbody').innerHTML = '';
  addRow({qty:1, unit:'se', price:0});
  await loadSeller();
  msg('Порожня форма готова');
};

// старт
(async function init(){
  try{
    addRow({qty:1, unit:'se', price:0});
    await loadSeller();
    msg('Готово до роботи');
  }catch(e){
    msg('Помилка ініціалізації: ' + e.message, true);
  }
})();
</script>
</body>
</html>
