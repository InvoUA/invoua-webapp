<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>InvoUA — рахунок за 60 секунд</title>
  <style>
    :root { --gap: 10px; }
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 0; padding: 14px; }
    h1 { font-size: 20px; margin: 0 0 12px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row { display:flex; gap:var(--gap); align-items:center; }
    label { font-size:12px; color:#444; }
    input, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#f8f8f8; text-align:left; }
    .btns { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:10px 14px; border:0; border-radius:999px; background:#0a84ff; color:#fff; font-weight:600; }
    button.secondary { background:#eee; color:#222; }
    .muted { color:#666; font-size:12px; }
    .toast { margin-top:10px; font-size:13px; }
    .ok { color: #0a7d2f; }
    .err { color: #b00020; }
    .hidden { display:none; }
    /* невидима зона для рендеру HTML інвойсу у PDF */
    #printArea { position: fixed; left: -99999px; top: 0; width: 794px; background: #fff; }
  </style>

  <!-- бібліотеки для PDF у браузері -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkF3M6s1Q4Hjsc1fBVj9pZr2gqB4nW4dDVX31t7Hc3r3jzT1j8F6H3B3l7lF9Z3q9Jt4qgphM8pGvR0b7mWWbw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5zsxgQ0m8+QZc0qE4nq9PzVqv5g4+J9rGgS3D0k8yG7sFZp3S7nOQ9yGhmkZbP3pZ2JjQH1xX9yVqf3L1/A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <h1>InvoUA — рахунок за 60 секунд</h1>

  <div class="grid">
    <div>
      <label>Покупець (назва/ПІБ)</label>
      <input id="buyer_name" placeholder="ТОВ Приклад">
    </div>
    <div>
      <label>Валюта</label>
      <select id="currency">
        <option>UAH</option><option>USD</option><option>EUR</option>
      </select>
    </div>
  </div>

  <table id="items">
    <thead>
      <tr>
        <th>Найменування</th><th style="width:80px">К-сть</th><th style="width:80px">Од.</th><th style="width:120px">Ціна</th><th style="width:40px"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="btns">
    <button id="add">+ Додати позицію</button>
    <button id="save">Зберегти рахунок</button>
  </div>

  <div id="result" class="hidden">
    <div class="btns">
      <button id="btnPdf">Завантажити PDF</button>
      <button id="btnHtml" class="secondary">Поділитися (HTML)</button>
      <button id="btnNew" class="secondary">Новий</button>
    </div>
    <div id="toast" class="toast ok"></div>
  </div>

  <div id="printArea"></div>

  <p class="muted">Ця сторінка працює як Telegram Mini App. API-адреса береться з параметра <code>?api=</code>.</p>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) try { tg.expand(); } catch(e) {}

  const $ = s => document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const API = qs.get('api')?.replace(/\/$/,'') || '';

  const tbody = $('#items tbody');
  function addRow(name='', qty='1', unit='se', price='0'){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name" placeholder="Послуга" value="${name}"></td>
      <td><input class="qty" type="number" step="0.01" value="${qty}"></td>
      <td><input class="unit" value="${unit}"></td>
      <td><input class="price" type="number" step="0.01" value="${price}"></td>
      <td><button class="secondary del">x</button></td>`;
    tr.querySelector('.del').onclick = () => tr.remove();
    tbody.appendChild(tr);
  }
  $('#add').onclick = () => addRow();
  addRow('Консультаційні послуги', '1', 'se', '1200');
  addRow('Реклама', '1', 'se', '500');

  function collectItems(){
    return [...tbody.querySelectorAll('tr')].map(tr => ({
      name: tr.querySelector('.name').value.trim(),
      qty: tr.querySelector('.qty').value || '1',
      unit: tr.querySelector('.unit').value || 'se',
      price: tr.querySelector('.price').value || '0'
    })).filter(it => it.name);
  }

  async function saveInvoice(){
    if(!API){ alert('Не задано ?api= у URL'); return; }
    const payload = {
      invoice: { currency: $('#currency').value },
      buyer:   { name: $('#buyer_name').value.trim() },
      items:   collectItems()
    };
    const r = await fetch(API + '/api/invoices', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error('API error ' + r.status); }
    return await r.json();
  }

  async function fetchInvoiceHtml(url){
    // обходимо ngrok warning
    const r = await fetch(url + (url.includes('?')?'&':'?') + 'ngrok-skip-browser-warning=1', {
      headers: { 'ngrok-skip-browser-warning': '1' }
    });
    if(!r.ok) throw new Error('HTML failed ' + r.status);
    return await r.text();
  }

  async function makePdfFromHtml(html){
    // рендеримо отриманий HTML у прихованій області та конвертуємо у PDF
    const holder = $('#printArea');
    holder.innerHTML = html;

    // невелика затримка, щоб браузер відмалював шрифти/зображення
    await new Promise(r => setTimeout(r, 50));

    const canvas = await html2canvas(holder, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const pdfW = pdf.internal.pageSize.getWidth();
    const pdfH = pdf.internal.pageSize.getHeight();

    // пропорційно вписуємо зображення в ширину сторінки
    const imgW = pdfW;
    const imgH = canvas.height * (imgW / canvas.width);

    let y = 0;
    if (imgH <= pdfH) {
      pdf.addImage(imgData, 'JPEG', 0, 0, imgW, imgH);
    } else {
      // простий пагінатор по висоті
      let remaining = imgH;
      let s = canvas;
      while (remaining > 0) {
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvas.width;
        const pageHeightPx = Math.min(canvas.height, Math.round(pdfH * canvas.width / pdfW));
        pageCanvas.height = pageHeightPx;

        const ctx = pageCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, -y * (canvas.width / pdfW), canvas.width, canvas.height);

        const pageImg = pageCanvas.toDataURL('image/jpeg', 0.95);
        pdf.addImage(pageImg, 'JPEG', 0, 0, pdfW, pdfH);

        remaining -= pdfH;
        y += pdfH;
        if (remaining > 0) pdf.addPage();
      }
    }

    // відкриваємо PDF
    const blobUrl = pdf.output('bloburl');
    if (window.Telegram?.WebApp?.openLink) {
      window.Telegram.WebApp.openLink(blobUrl);
    } else {
      const a = document.createElement('a');
      a.href = blobUrl; a.download = 'invoice.pdf';
      document.body.appendChild(a); a.click();
      setTimeout(()=>URL.revokeObjectURL(blobUrl), 5000);
    }
  }

  $('#save').onclick = async () => {
    try{
      const res = await saveInvoice();
      $('#result').classList.remove('hidden');
      $('#toast').classList.remove('err'); $('#toast').classList.add('ok');
      $('#toast').textContent = `Збережено. № ${res.number}. Сума: ${res.total}`;

      // HTML відкриваємо напряму
      $('#btnHtml').onclick = () =>
        (window.Telegram?.WebApp?.openLink
          ? window.Telegram.WebApp.openLink(res.public_url)
          : window.open(res.public_url, '_blank'));

      // PDF — генеруємо на клієнті з HTML
      $('#btnPdf').onclick  = async () => {
        try {
          const html = await fetchInvoiceHtml(res.public_url);
          await makePdfFromHtml(html);
        } catch (e) {
          $('#toast').classList.remove('ok'); $('#toast').classList.add('err');
          $('#toast').textContent = 'Помилка PDF: ' + e.message;
        }
      };

      $('#btnNew').onclick  = () => location.reload();
    }catch(e){
      $('#result').classList.remove('hidden');
      $('#toast').classList.remove('ok'); $('#toast').classList.add('err');
      $('#toast').textContent = 'Помилка збереження: ' + e.message;
    }
  };
})();
</script>
</body>
</html>
