<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>InvoUA — рахунок за 60 секунд</title>
  <style>
    :root { --gap: 10px; }
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 0; padding: 14px; }
    h1 { font-size: 20px; margin: 0 0 12px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row { display:flex; gap:var(--gap); align-items:center; }
    label { font-size:12px; color:#444; }
    input, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#f8f8f8; text-align:left; }
    .btns { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:10px 14px; border:0; border-radius:999px; background:#0a84ff; color:#fff; font-weight:600; }
    button.secondary { background:#eee; color:#222; }
    .muted { color:#666; font-size:12px; }
    .toast { margin-top:10px; font-size:13px; }
    .ok { color: #0a7d2f; }
    .err { color: #b00020; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>InvoUA — рахунок за 60 секунд</h1>

  <div class="grid">
    <div>
      <label>Покупець (назва/ПІБ)</label>
      <input id="buyer_name" placeholder="ТОВ Приклад">
    </div>
    <div>
      <label>Валюта</label>
      <select id="currency">
        <option>UAH</option><option>USD</option><option>EUR</option>
      </select>
    </div>
  </div>

  <table id="items">
    <thead>
      <tr>
        <th>Найменування</th><th style="width:80px">К-сть</th><th style="width:80px">Од.</th><th style="width:120px">Ціна</th><th style="width:40px"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="btns">
    <button id="add">+ Додати позицію</button>
    <button id="save">Зберегти рахунок</button>
  </div>

  <div id="result" class="hidden">
    <div class="btns">
      <button id="btnPdf">Завантажити PDF</button>
      <button id="btnHtml" class="secondary">Поділитися (HTML)</button>
      <button id="btnNew" class="secondary">Новий</button>
    </div>
    <div id="toast" class="toast ok"></div>
  </div>

  <p class="muted">Ця сторінка працює як Telegram Mini App. API-адреса береться з параметра <code>?api=</code>.</p>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) try { tg.expand(); } catch(e) {}

  // ---- утиліти ----
  const $ = s => document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const API = qs.get('api')?.replace(/\/$/,'') || '';

  const tbody = $('#items tbody');
  function addRow(name='', qty='1', unit='se', price='0'){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name" placeholder="Послуга" value="${name}"></td>
      <td><input class="qty" type="number" step="0.01" value="${qty}"></td>
      <td><input class="unit" value="${unit}"></td>
      <td><input class="price" type="number" step="0.01" value="${price}"></td>
      <td><button class="secondary del">x</button></td>`;
    tr.querySelector('.del').onclick = () => tr.remove();
    tbody.appendChild(tr);
  }

  $('#add').onclick = () => addRow();
  // стартові 2 позиції
  addRow('Консультаційні послуги', '1', 'se', '1200');
  addRow('Реклама', '1', 'se', '500');

  function collectItems(){
    return [...tbody.querySelectorAll('tr')].map(tr => ({
      name: tr.querySelector('.name').value.trim(),
      qty: tr.querySelector('.qty').value || '1',
      unit: tr.querySelector('.unit').value || 'se',
      price: tr.querySelector('.price').value || '0'
    })).filter(it => it.name);
  }

  async function saveInvoice(){
    if(!API){ alert('Не задано ?api= у URL'); return; }
    const payload = {
      invoice: { currency: $('#currency').value },
      buyer:   { name: $('#buyer_name').value.trim() },
      items:   collectItems()
    };
    const r = await fetch(API + '/api/invoices', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!r.ok){ throw new Error('API error ' + r.status); }
    return await r.json();
  }

  // головна фіча: тягнемо PDF з заголовком, щоб обійти «віталку» ngrok
  async function downloadPdf(url){
    const r = await fetch(url, { headers: { 'ngrok-skip-browser-warning': '1' } });
    if(!r.ok) throw new Error('PDF failed ' + r.status);
    const blob = await r.blob();
    const blobUrl = URL.createObjectURL(blob);

    // спробуємо «нативне» відкриття
    if (tg?.openLink) {
      tg.openLink(blobUrl);
    } else {
      // звичайний браузер: автоскачування
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = 'invoice.pdf';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>URL.revokeObjectURL(blobUrl), 5000);
    }
  }

  // UI-хендлери
  $('#save').onclick = async () => {
    try{
      const res = await saveInvoice();
      $('#result').classList.remove('hidden');
      $('#toast').textContent = `Збережено. № ${res.number}. Сума: ${res.total}`;
      $('#btnPdf').onclick  = () => downloadPdf(res.pdf_url);
      $('#btnHtml').onclick = () => tg?.openLink ? tg.openLink(res.public_url) : window.open(res.public_url, '_blank');
      $('#btnNew').onclick  = () => location.reload();
    }catch(e){
      $('#result').classList.remove('hidden');
      $('#toast').classList.remove('ok'); $('#toast').classList.add('err');
      $('#toast').textContent = 'Помилка збереження: ' + e.message;
    }
  };
})();
</script>
</body>
</html>
