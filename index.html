<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InvoUA — швидкий рахунок</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .row { display:flex; gap:8px; }
    .col { flex:1; }
    label { display:block; font-size:12px; color:#444; margin:8px 0 4px; }
    input, select, button { width: 100%; padding:10px; font-size:14px; box-sizing: border-box; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#fafafa; text-align:left; }
    tfoot td { border:none; }
    .right { text-align:right; }
    .actions { display:flex; gap:8px; margin-top:12px; }
    .hint { font-size:12px; color:#666; margin-top:8px; }
    .ok { color: #0a8; }
    .err { color: #c00; }
  </style>
</head>
<body>
  <h1>InvoUA — рахунок за 60 секунд</h1>

  <div class="row">
    <div class="col">
      <label>Покупець (назва/ПІБ)</label>
      <input id="buyer_name" placeholder="ТОВ Покупець або Іван Іванов" />
    </div>
    <div style="width:140px">
      <label>Валюта</label>
      <select id="currency">
        <option value="UAH" selected>UAH</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
      </select>
    </div>
  </div>

  <table id="items_tbl">
    <thead>
      <tr><th style="width:42%">Найменування</th><th style="width:15%">К-сть</th><th style="width:15%">Од.</th><th style="width:18%">Ціна</th><th style="width:10%"></th></tr>
    </thead>
    <tbody id="items_body">
      <!-- рядки додаються скриптом -->
    </tbody>
  </table>

  <div class="actions">
    <button id="add_row">+ Додати позицію</button>
    <button id="save_btn">Зберегти рахунок</button>
  </div>

  <div id="result" class="hint"></div>

  <div class="actions" id="after_actions" style="display:none">
    <button id="btn_pdf">Завантажити PDF</button>
    <button id="btn_html">Поділитися (HTML)</button>
    <button id="btn_new">Новий рахунок</button>
  </div>

  <script>
    // ---- Telegram WebApp integration (без помилок, якщо не в Telegram)
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      tg.expand();
      tg.ready();
    }

    // ---- API base з ?api=... (бот підставляє). Якщо нема — показуємо підказку.
    const params = new URLSearchParams(location.search);
    const API_BASE = params.get('api') || '';
    if (!API_BASE) {
      document.getElementById('result').innerHTML =
        '<span class="err">⚠ Не передано параметр ?api=… у URL. Відкрий через бота.</span>';
    }

    // ---- Таблиця товарів/послуг
    const itemsBody = document.getElementById('items_body');
    function addRow(name='', qty='1', unit='service', price='0.00') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input placeholder="Найменування" value="${name}"/></td>
        <td><input type="number" step="0.01" min="0.01" value="${qty}"/></td>
        <td><input value="${unit}"/></td>
        <td><input type="number" step="0.01" min="0" value="${price}"/></td>
        <td class="right"><button class="rm">×</button></td>`;
      tr.querySelector('.rm').onclick = () => { tr.remove(); };
      itemsBody.appendChild(tr);
    }
    addRow(); // перший рядок за замовчуванням

    document.getElementById('add_row').onclick = () => addRow();

    // ---- Збір payload
    function collectPayload() {
      const buyer_name = document.getElementById('buyer_name').value.trim();
      const currency = document.getElementById('currency').value;

      const items = [];
      for (const tr of itemsBody.querySelectorAll('tr')) {
        const tds = tr.querySelectorAll('td');
        const name = tds[0].querySelector('input').value.trim();
        const qty  = tds[1].querySelector('input').value || '1';
        const unit = tds[2].querySelector('input').value || 'service';
        const price= tds[3].querySelector('input').value || '0';
        if (name) {
          items.push({ name, qty, unit, price, vat_rate: 'none' });
        }
      }

      return {
        invoice: { currency },
        buyer: { name: buyer_name || 'Покупець' },
        items
      };
    }

    // ---- Відправка на бекенд
    const resBox = document.getElementById('result');
    const afterBox = document.getElementById('after_actions');
    let last = { invoice_id: null, public_url: null, pdf_url: null };

    async function postInvoice() {
      resBox.textContent = '⏳ Зберігаю…';
      try {
        const payload = collectPayload();
        if (!API_BASE) throw new Error('Немає API_BASE');
        const resp = await fetch(`${API_BASE}/api/invoices`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await resp.json();
        if (!resp.ok || !j.ok) throw new Error(j.detail || 'Помилка збереження');

        last = { invoice_id: j.invoice_id, public_url: j.public_url, pdf_url: j.pdf_url };
        resBox.innerHTML = `<span class="ok">✅ Збережено. ID: ${j.invoice_id}, до оплати: ${j.total}</span>`;
        afterBox.style.display = 'flex';

        // Покажемо popup у Telegram
        if (tg && tg.showPopup) {
          tg.showPopup({
            title: "Інвойс збережено",
            message: "Що зробити далі?",
            buttons: [
              {id:"pdf", type:"default", text:"Завантажити PDF"},
              {id:"share", type:"default", text:"Поділитися (HTML)"},
              {id:"new", type:"ok", text:"Новий"}
            ]
          }, (btnId) => {
            if (btnId === "pdf" && last.pdf_url) window.open(last.pdf_url, "_blank");
            if (btnId === "share" && last.public_url) window.open(last.public_url, "_blank");
          });
        }
      } catch (e) {
        console.error(e);
        resBox.innerHTML = `<span class="err">❌ ${e.message || e}</span>`;
        afterBox.style.display = 'none';
      }
    }

    // ---- Обробники кнопок
    document.getElementById('save_btn').onclick = postInvoice;
    document.getElementById('btn_pdf').onclick = () => last.pdf_url && window.open(last.pdf_url, '_blank');
    document.getElementById('btn_html').onclick = () => last.public_url && window.open(last.public_url, '_blank');
    document.getElementById('btn_new').onclick = () => location.reload();
  </script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
